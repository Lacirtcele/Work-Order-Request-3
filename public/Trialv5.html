<<<<<<< HEAD
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('background.jpg');
      background-size: cover;
      color: black; /* Ensuring body text is black */
    }

    /* Form and table styles */
    .form-group {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    label {
      display: inline-block;
      width: 180px;
      font-weight: bold;
      font-size: 11pt;
      color: black;
    }
    input, textarea, select {
      flex-grow: 1;
      width: 60%;
      padding: 8px;
      font-size: 11pt;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      color: black;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #6a5acd;
      box-shadow: 0 0 5px rgba(106, 90, 205, 0.5);
      outline: none;
      background: white;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 8pt;
      color: black;
    }
    th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
      font-size: 8pt;
      color: black; /* Explicitly setting table cell color */
    }
    .signatories {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      color: black;
    }
    .signature-box {
      text-align: center;
      width: 45%;
    }
    .signature-line {
      border-top: none;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    
    /* Button styles */
    .btn-print button, .main-content button, .dashboard-actions button, .wo-btn button, .details-actions button, #add-evidence-button {
        padding: 8px 16px;
        font-size: 11pt;
        margin: 10px 5px;
        border: none;
        border-radius: 8px;
        background-color: #6a5acd;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-print button:hover, .main-content button:hover, .dashboard-actions button:hover, .wo-btn button:hover, .details-actions button:hover, #add-evidence-button:hover {
        background-color: #5544aa;
        transform: translateY(-2px);
    }
    .wo-btn.edit-btn { background-color: #28a745; }
    .wo-btn.edit-btn:hover { background-color: #218838; }
    .wo-btn.delete-btn { background-color: #dc3545; }
    .wo-btn.delete-btn:hover { background-color: #c82333; }
    .wo-btn.print-btn { background-color: #17a2b8; }
    .wo-btn.print-btn:hover { background-color: #138496; }
    .wo-btn.gantt-btn { background-color: #ffc107; }
    .wo-btn.gantt-btn:hover { background-color: #e0a800; }
    .details-actions { text-align: center; margin-top: 10px; }
    
    /* Other page elements */
    .form-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .form-row .form-group {
      flex: 1;
      display: flex;
      align-items: center;
    }
    .form-row label {
      width: auto;
      min-width: 100px;
      flex-shrink: 0;
      font-size: 11pt;
    }
    .form-row input {
      flex-grow: 1;
      width: auto;
      font-size: 11pt;
    }
    #dashboard.hidden-by-password, #new-order-popup {
        display: none;
    }
    #print-template {
        display: none;
    }
    @media print {
        @page {
            size: 8.5in 13in;
            margin: 0;
        }
        body > *:not(#print-template):not(#print-summary-container):not(#master-print-popup-overlay) {
            display: none !important;
        }
        #master-print-popup-overlay {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            background: white !important;
            z-index: 99999;
        }
        #master-print-popup-overlay .popup-content {
            box-shadow: none;
            border: none;
            padding: 20px;
            width: 100%;
            max-width: 100%;
        }
        #master-print-popup-overlay .close-btn, 
        #master-print-popup-overlay button {
            display: none !important;
        }
        body {
            margin: 0;
            padding: 0;
            width: 8.5in;
            height: 13in;
            position: relative;
        }
        #print-template, #print-summary-container {
          display: block !important;
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          position: relative;
          z-index: 1;
        }
        .print-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('background.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 300px;
            filter: grayscale(100%);
            opacity: 0.3;
            z-index: -1;
        }
        .print-page {
          width: 100%;
          height: calc(50% - 0.5px);
          box-sizing: border-box;
          padding: 10px;
          position: relative;
          margin-top: 0;
          margin-bottom: 0;
        }
        .print-label {
          position: absolute;
          top: 5px;
          right: 5px;
          font-size: 10pt;
          font-weight: bold;
          color: black;
        }
        input, textarea {
          border: none !important;
          background: none !important;
          color: black !important;
          font-size: 8pt !important;
        }
        .print-page .form-group {
          display: flex;
          align-items: baseline;
          margin: 2px 0;
        }
        .print-page .form-group label {
          width: 120px !important;
          font-size: 8pt !important;
          flex-shrink: 0;
          color: black;
        }
        .print-page .form-group span {
          flex-grow: 1;
          font-size: 8pt !important;
          text-align: left;
          color: black;
        }
        img, .header {
          display: block !important;
        }
        .print-content {
            page-break-inside: avoid;
        }
        .print-page .form-row {
          gap: 5px;
        }
        .print-page table {
          font-size: 8pt;
          margin-top: 5px;
        }
        .print-page th, .print-page td {
          font-size: 8pt;
          color: black;
        }
        .print-page .signature-box span {
          display: block !important;
        }
        .print-page h3, .print-page h4 {
          margin-top: 3px;
          margin-bottom: 10px;
          color: black;
        }
        .print-page .signatories:first-of-type {
          margin-top: 10px;
        }
        .print-page .signatories {
          margin-top: 5px;
        }
        .print-page #print-description-1,
        .print-page #print-remarks-1,
        .print-page #print-description-2,
        .print-page #print-remarks-2 {
            white-space: pre-wrap;
        }
        #evidence-section {
          display: none !important;
        }
        .print-page #print-evidence-1,
        .print-page #print-evidence-2 {
          display: block !important;
          position: absolute;
          bottom: 10px;
          right: 10px;
          width: 192px;
          height: 192px;
        }
        .print-page #print-evidence-1 img,
        .print-page #print-evidence-2 img {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
        }
        .dotted-line-separator {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px dotted black;
        }
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }
    .popup-content {
      background: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('background.jpg') center center no-repeat;
      background-size: cover, auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 900px;
      max-height: 95%;
      position: relative;
      display: flex;
      flex-direction: column;
      color: black;
    }
    .popup-content h3 {
      text-align: center;
      margin-top: 0;
      color: black;
    }
    .popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1;
      color: black;
    }
    .popup-content .minimize-btn {
        position: absolute;
        top: 10px;
        right: 45px; /* Position it to the left of the close button */
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1;
        color: black;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 100;
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .main-content {
      padding-top: 20px;
      overflow-y: auto;
    }
    .popup-header {
      padding-top: 20px;
      margin-bottom: 10px;
      text-align: center;
    }
    .popup-entries-container {
        max-height: 100%;
        overflow-y: auto;
    }
    .signature-img-container {
      position: relative;
      width: 100%;
      height: 60px;
    }
    .signature-img-container img {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        height: 50px;
        object-fit: contain;
        display: none;
    }
    #table-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }
    #table-popup-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      position: relative;
      overflow-y: auto;
      color: black;
    }
    #table-popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
      color: black;
    }
    #materials-table {
        margin-top: 20px;
    }
    #activities-table {
        margin-top: 20px;
    }
    #print-summary-container {
      display: none;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #print-summary-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: black;
    }
    #print-summary-container table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #print-summary-container th, #print-summary-container td {
      border: 1px solid #000;
      padding: 8px;
      font-size: 10pt;
      color: black;
    }
    #print-summary-container .header {
        overflow: hidden;
        margin-bottom: 5px;
        text-align: center;
    }
    #print-summary-container .header img {
        width: 5000px;
        float: left;
    }
    #print-summary-container .header img.right {
        float: right;
    }
    #duplicate-alert {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      animation: flashRed 0.5s ease-in-out;
    }
    .alert-content {
      animation: pulse 1s infinite;
    }
    #duplicate-alert button {
      margin-top: 20px;
      padding: 8px 20px;
      font-size: 16px;
      background: white;
      color: red;
      border: none;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    @keyframes flashRed {
      0%, 100% { background-color: rgba(255, 0, 0, 0.9); }
      50% { background-color: rgba(255, 50, 50, 0.95); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #password-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)), url('background.jpg') center center no-repeat;
      background-size: cover, auto;
      z-index: 999999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    #password-overlay-content {
      background: rgba(255, 255, 255, 0.9);
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(5px);
    }
    #password-overlay h1 {
        font-size: 30px;
        font-weight: bold;
        color: black;
        margin-bottom: 20px;
    }
    #password-overlay input {
      width: 250px;
      padding: 10px;
      font-size: 16px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 5px;
      color: black;
    }
    #password-overlay button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    /* Dashboard Specific Styles */
    #dashboard-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        color: black;
    }
    #work-order-list-container {
        flex: 1;
        min-width: 300px;
    }
    #details-and-gantt-container {
        flex: 2;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 20px;
      color: black;
    }
    .stats-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        gap: 20px;
    }
    .stat-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
        flex: 1;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        color: black;
    }
    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .stat-box h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
        color: black;
    }
    .stat-box p {
        margin: 0;
        font-size: 36px;
        font-weight: bold;
    }
    .dashboard-section {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        color: black;
    }
    .dashboard-section h2 {
        text-align: center;
        margin-top: 0;
        color: black;
    }
    .dashboard-actions {
        text-align: center;
        margin-bottom: 20px;
    }
    .wo-list-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px; /* New: Set a maximum height */
      overflow-y: auto; /* New: Enable vertical scrolling */
    }
    .wo-btn {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
      color: black;
    }
    .wo-btn:hover {
      background: #f0f0f0;
    }
    .wo-list-actions {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }
    .wo-list-actions select, .wo-list-actions input {
        padding: 4px;
        font-size: 9pt;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    .wo-gantt-section {
        width: 100%;
        margin-top: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 250px;
        color: black;
    }
    #wo-gantt-canvas {
        width: 100% !important;
        height: 100% !important;
    }
    #selected-wo-details-section {
      display: none; /* Initially hidden */
      margin-top: 20px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: black;
    }
    #selected-wo-details-section h2 {
      text-align: center;
      margin-top: 0;
      color: black;
    }
    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 20px;
      margin-bottom: 20px;
    }
    .details-grid p {
      margin: 0;
      color: black;
    }
    .details-grid strong {
      color: black;
    }
    .gantt-all-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 20px;
    }
    .single-gantt-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        color: black;
    }
    .single-gantt-card canvas {
        width: 100% !important;
        height: 150px !important;
    }
    .search-bar-container {
      margin-bottom: 15px;
      text-align: center;
    }
    #activities-table-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }
    #activities-table-popup-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      position: relative;
      overflow-y: auto;
      color: black;
    }
    #activities-table-popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
      color: black;
    }
    #activities-table-popup-content button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #6a5acd;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #image-preview-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10002;
        justify-content: center;
        align-items: center;
    }
    #image-preview-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }
    #image-preview-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #image-preview-content .close-btn {
        position: absolute;
        top: -15px;
        right: -15px;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }
  </style>
</head>
<body>

<div id="password-overlay">
  <div id="password-overlay-content">
      <h1>UNIVERSITY OF CAGAYAN VALLEY</h1>
      <input type="password" id="system-password" placeholder="Enter Password">
      <button id="enter-button">Enter</button>
  </div>
</div>

<div id="print-template">
    <div class="print-background"></div>
    <div class="print-page">
      <div class="print-label">OPPM copy - File</div>
      <div class="header" style="overflow: hidden; margin-bottom: 5px;">
         <img src="images/UCVV.png" alt="logo" width="780" style="float: center;">
               <div style="text-align: center;">
                   <hr style="border: none; height: 2px; background-color: black; margin: 3px 0;">
        </div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Requesting Party:</label><span id="print-req-party-1"></span></div>
          <div class="form-group"><label>Position:</label><span id="print-req-position-1"></span></div>
          <div class="form-group"><label>W.O. Request No.:</label><span id="print-wo-number-1"></span></div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Building:</label><span id="print-building-1"></span></div>
          <div class="form-group"><label>Date Requested:</label><span id="print-date-requested-1"></span></div>
          <div class="form-group"><label>Date Started:</label><span id="print-date-started-1"></span></div>
      </div>
      <div class="form-group"><label>Estimate Date Accomplished:</label><span id="print-estimate-date-accomplished-1"></span></div>
      <div class="form-group"><label>Description:</label><span id="print-description-1"></span></div>
      <h4 style="margin-top: 5px; margin-bottom: 5px;">TO BE FILLED BY OPPM/OPLS STAFF</h4>
      <table style="font-size: 8pt;">
        <thead>
          <tr>
            <th>Room/Office</th>
            <th>QTY</th>
            <th>PARTICULARS</th>
            <th>AVAILABLE</th>
            <th>NOT AVAILABLE</th>
          </tr>
        </thead>
        <tbody id="print-materials-body-1"></tbody>
      </table>
      <div class="form-group"><label>Status:</label><span id="print-status-1"></span></div>
      <div class="form-group"><label>Remarks:</label><span id="print-remarks-1"></span></div>
      <div class="signatories" style="margin-top: 15px;">
        <div class="signature-box" style="width: 48%;">
           <div style="text-align: left; font-size: 9pt;"><strong>Performed by:</strong></div><br>
        <div style="text-align: center; font-size: 9pt;">
          <span id="print-performed-by-1" style="display: block; border-bottom: 1px solid #000; padding-bottom: 2px;"></span>
          <div class="signature-line"></div>
          OPPM Technician
          </div>
        </div>
        <div class="signature-box" style="width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Requesting Party:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <strong><span id="print-printedRequestorName-1"></span></strong>
            <div class="signature-line"></div>
            <span id="print-printedRequestorPosition-1"></span>
          </div>
        </div>
      </div>
      <div class="signatories" style="margin-top: 10px;">
        <div class="signature-box" style="margin: auto; width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Concurred by:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <div class="signature-img-container">
                <img id="print-signature-1" src="signature.jpg" alt="Signature">
            </div>
            <strong id="print-concurred-by-name-1"></strong><br>
            <div class="signature-line"></div>
            <span id="print-concurred-by-title-1"></span>
          </div>
        </div>
      </div>
      <div id="print-evidence-1">
        </div>
    </div>
    <div class="dotted-line-separator"></div>
    <div class="print-page">
      <div class="print-label">Requestor's copy</div>
      <div class="header" style="overflow: hidden; margin-bottom: 5px;">
         <img src="images/UCVV.png" alt="logo" width="780" style="float: left;">
                <div style="text-align: center;">
                    <hr style="border: none; height: 2px; background-color: black; margin: 3px 0;">
        </div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Requesting Party:</label><span id="print-req-party-2"></span></div>
          <div class="form-group"><label>Position:</label><span id="print-req-position-2"></span></div>
          <div class="form-group"><label>W.O. Request No.:</label><span id="print-wo-number-2"></span></div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Building:</label><span id="print-building-2"></span></div>
          <div class="form-group"><label>Date Requested:</label><span id="print-date-requested-2"></span></div>
          <div class="form-group"><label>Date Started:</label><span id="print-date-started-2"></span></div>
      </div>
      <div class="form-group"><label>Estimate Date Accomplished:</label><span id="print-estimate-date-accomplished-2"></span></div>
      <div class="form-group"><label>Description:</label><span id="print-description-2"></span></div>
      <h4 style="margin-top: 5px; margin-bottom: 5px;">TO BE FILLED BY OPPM/OPLS STAFF</h4>
      <table style="font-size: 8pt;">
        <thead>
          <tr>
            <th>Room/Office</th>
            <th>QTY</th>
            <th>PARTICULARS</th>
            <th>AVAILABLE</th>
            <th>NOT AVAILABLE</th>
          </tr>
        </thead>
        <tbody id="print-materials-body-2"></tbody>
      </table>
      <div class="form-group"><label>Status:</label><span id="print-status-2"></span></div>
      <div class="form-group"><label>Remarks:</label><span id="print-remarks-2"></span></div>
      <div class="signatories" style="margin-top: 15px;">
        <div class="signature-box" style="width: 48%;">
           <div style="text-align: left; font-size: 9pt;"><strong>Performed by:</strong></div><br>
        <div style="text-align: center; font-size: 9pt;">
          <span id="print-performed-by-2" style="display: block; border-bottom: 1px solid #000; padding-bottom: 2px;"></span>
          <div class="signature-line"></div>
          OPPM Technician
          </div>
        </div>
        <div class="signature-box" style="width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Requesting Party:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <strong><span id="print-printedRequestorName-2"></span></strong>
            <div class="signature-line"></div>
            <span id="print-printedRequestorPosition-2"></span>
          </div>
        </div>
      </div>
      <div class="signatories" style="margin-top: 10px;">
        <div class="signature-box" style="margin: auto; width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Concurred by:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <div class="signature-img-container">
                <img id="print-signature-2" src="signature.jpg" alt="Signature">
            </div>
            <strong id="print-concurred-by-name-2"></strong><br>
            <div class="signature-line"></div>
            <span id="print-concurred-by-title-2"></span>
          </div>
        </div>
      </div>
      <div id="print-evidence-2">
        </div>
    </div>
    <div class="dotted-line-separator"></div>
</div>

<div id="dashboard" class="hidden-by-password">
    <div class="dashboard-header">
        <img src="images/UCV.png" alt="logo" width="100" style="float: left;">
        <img src="images/oppm_logo.png" alt="logo" width="100" style="float: right;">
        <h2>UNIVERSITY OF CAGAYAN VALLEY</h2>
        <p>OFFICE OF THE PHYSICAL PLANT AND MAINTENANCE</p>
        <p>WORK ORDER DASHBOARD</p>
    </div>

    <div class="stats-container">
        <div class="stat-box" onclick="viewAllGanttCharts()">
            <h3>View All Gantt Charts</h3>
            <p>📊</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('Pending')">
            <h3>Pending</h3>
            <p id="pending-count">0</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('In Progress')">
            <h3>In Progress</h3>
            <p id="inprogress-count">0</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('Completed')">
            <h3>Completed</h3>
            <p id="completed-count">0</p>
        </div>
    </div>

    <div class="dashboard-actions">
        <button onclick="clearAllFields(); openNewOrderPopup();">📝 New Order Request</button>
        <button onclick="openWorkOrderList('All')">📂 View All Saved Orders</button>
        <button onclick="printSummary()">🖨️ Print Summary</button>
    </div>

    <div id="dashboard-container">
        <div id="work-order-list-container" class="dashboard-section">
            <h2 style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                Work Order List
                <button onclick="openAboutPopup()" title="About the Author" style="font-family: 'Times New Roman', serif; font-weight: bold; font-style: italic; width: 24px; height: 24px; border-radius: 50%; padding: 0; font-size: 14px; line-height: 24px; vertical-align: middle; margin: 0; background-color: #6a5acd; color: white; border: none; cursor: pointer;">i</button>
            </h2>
            <div class="search-bar-container">
              <input type="search" id="wo-search" oninput="searchWorkOrders()" placeholder="Search by WO number..." style="width: 90%;">
            </div>
            <div id="wo-list" class="wo-list-container">
            </div>
        </div>
        <div id="details-and-gantt-container">
            <div id="selected-wo-details-section">
                <h2 id="details-section-title">Work Order Details & Gantt Chart</h2>
                <div class="details-grid">
                    <p><strong>Work Order #:</strong> <span id="detail-wo-number"></span></p>
                    <p><strong>Requesting Party:</strong> <span id="detail-req-party"></span></p>
                    <p><strong>Building:</strong> <span id="detail-building"></span></p>
                    <p><strong>Position:</strong> <span id="detail-req-position"></span></p>
                    <p><strong>Date Requested:</strong> <span id="detail-date-requested"></span></p>
                    <p><strong>Date Started:</strong> <span id="detail-date-started"></span></p>
                    <p><strong>Estimated Date of Accomplishment:</strong> <span id="detail-date-accomplished"></span></p>
                    <p><strong>Status:</strong> <span id="detail-status"></span></p>
                    <p><strong>Total Cost:</strong> <span id="detail-total-cost"></span></p>
                </div>
                <div class="details-actions">
                    <button id="edit-button">📝 Edit</button>
                    <button id="print-button">🖨️ Print</button>
                    <button id="delete-button">🗑️ Delete</button>
                    <button id="view-activities-button">📄 View Activities</button>
                    <button id="edit-activities-button">✏️ Edit Activities</button>
                    <button id="costing-button" onclick="openCostingPopup()">💰 Costing</button>
                    <button id="master-print-button" onclick="showMasterPrintPreview()">Master Print</button>
                </div>
                <div class="wo-gantt-section">
                    <h4>Gantt Chart Preview</h4>
                    <canvas id="wo-gantt-canvas"></canvas>
                </div>
                <div id="evidence-section" class="dashboard-section" style="margin-top: 20px;">
                    <h4>Evidence</h4>
                    <div id="evidence-preview-details" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; min-height: 120px; border-radius: 8px;">
                        </div>
                    <input type="file" id="evidence-upload-details" multiple accept="image/*" style="display: block; margin-bottom: 10px;">
                    <button id="add-evidence-button">Add Selected Images</button>
                </div>
            </div>
            <div id="all-gantt-charts-section" style="display: none;" class="dashboard-section">
                <h2>All Work Order Timelines</h2>
                <div id="all-gantt-container" class="gantt-all-container">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="new-order-popup" class="popup-overlay">
    <div class="popup-content">
        <span class="minimize-btn" onclick="closeNewOrderPopup()">—</span>
        <span class="close-btn" onclick="closeNewOrderPopup()">×</span>
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="btn-print">
                    <button onclick="printCurrentForm()">🖨️ Print</button>
                    <button onclick="clearAllFields()">🧹 Clear Data</button>
                    <button onclick="saveWorkOrder()">💾 Save</button>
                </div>
                <div style="font-size: 11pt;">
                    <strong>Last WO Entered:</strong>
                    <span id="last-wo-in-popup" style="color: #6a5acd; font-weight: bold;">N/A</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group"><label>Requesting Party:</label><input type="text" id="req-party" oninput="syncRequestor()"></div>
                <div class="form-group"><label>Position:</label><input type="text" id="req-position" oninput="syncRequestor()"></div>
                <div class="form-group"><label>W.O. Request No.:</label><input type="text" id="wo-number"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Building:</label><input type="text" id="building"></div>
                <div class="form-group"><label>Date Requested:</label><input type="date" id="date-requested"></div>
                <div class="form-group"><label>Date Started:</label><input type="date" id="date-started"></div>
            </div>
            <div class="form-group"><label>Estimate Date Accomplished:</label><input type="date" id="estimate-date-accomplished"></div>
            <div class="form-group"><label>Description:</label><textarea id="description"></textarea></div>

            <div style="text-align: center; margin: 20px 0;">
                <button onclick="showTablePopup()">Fill Material Details 📋</button>
            </div>

            <div class="form-group">
                <label>Status:</label>
                <select id="status">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="form-group"><label>Remarks:</label><textarea id="remarks"></textarea></div>

            <div class="signatories">
                <div class="signature-box">
                    <div style="text-align: left;"><strong>Performed by:</strong></div>
                    <div style="text-align: center;">
                        <input type="text" id="performed-by" placeholder="Enter technician name" style="width: 90%; text-align: center; border-bottom: 1px solid #000;">
                        <div class="signature-line"></div>
                        OPPM Technician
                    </div>
                </div>
                <div class="signature-box">
                    <div style="text-align: left;"><strong>Requesting Party:</strong></div>
                    <div style="text-align: center;">
                        <strong><span id="printedRequestorName">________________________</span></strong>
                        <div class="signature-line"></div>
                        <span id="printedRequestorPosition">________________________</span>
                    </div>
                </div>
            </div>
            <div class="signatories">
                <div class="signature-box" style="margin: auto;">
                    <div style="text-align: left;"><strong>Concurred by:</strong></div>
                    <div style="text-align: center;">
                        <select id="concurred-by-select" onchange="updateConcurredBy()">
                            <option value="ENGR. BENEDICT L. LOSTE, RCE" data-title="OPPM Director">ENGR. BENEDICT L. LOSTE, RCE</option>
                            <option value="ENGR. GLENN D. LUNA, REE, MBA" data-title="Supervisor, Electrical Unit">ENGR. GLENN D. LUNA, REE, MBA</option>
                        </select>
                        <br>
                        <div class="signature-line"></div>
                        <span id="concurred-by-title">OPPM Director</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="about-popup" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeAboutPopup()">×</span>
        <img src="images/grad_pic.jpg" alt="Author's Picture" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px auto; display: block;">
        <h3 style="margin-bottom: 20px;">About the Author</h3>
        <p style="text-align: left; line-height: 1.6; font-size: 12pt;">
            This system was created and developed by <strong>Engr. Glenn Dela Cruz Luna, REE, RME, MBA</strong>, a licensed professional with a Bachelor of Science in Electrical Engineering from Cagayan State University and a Master’s degree in Business Administration from the University of Cagayan Valley.
            <br><br>
            He currently holds the position of Electrical Engineer and Electrical Supervisor at the University of Cagayan Valley, where he leads key initiatives in infrastructure and technical operations.
        </p>
    </div>
</div>

<div id="image-preview-overlay" onclick="closeImagePreview()">
    <div id="image-preview-content">
        <span class="close-btn" onclick="closeImagePreview()">×</span>
        <img id="preview-img" src="" alt="Image Preview">
    </div>
</div>

<div id="duplicate-alert">
    <div style="font-size: 40px; margin-bottom: 10px;">🚨</div>
    <div class="alert-content"><strong>Duplicate WO Number!</strong></div>
    <div>This WO number already exists.</div>
    <button onclick="hideDuplicateAlert()">OK</button>
</div>

<audio id="alert-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU5LjI3LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8" preload="auto"></audio>

<div id="table-popup-overlay">
    <div id="table-popup-content">
        <span class="close-btn" onclick="closeTablePopup()">×</span>
        <h3 style="text-align: center;">Material & Staff Details 📋</h3>
        <table id="materials-table">
            <thead>
                <tr>
                    <th>Room/Office</th>
                    <th>QTY</th>
                    <th>PARTICULARS</th>
                    <th>AVAILABLE</th>
                    <th>NOT AVAILABLE</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="materials-body"></tbody>
        </table>
        <button id="add-material-btn" onclick="addMaterialRow()">➕ Add Row</button>
    </div>
</div>

<div id="activities-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeActivitiesPopup()">×</span>
        <h3>Work Order Activities</h3>
        <div id="activities-list" style="overflow-y: auto;">
        </div>
    </div>
</div>

<div id="activities-table-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeActivitiesTablePopup()">×</span>
        <h3 style="text-align: center;">Edit Activities 📝</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">Editing activities for Work Order: <span id="activities-wo-number-display"></span></p>
        <table id="activities-table">
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Date Start</th>
                    <th>Date End</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="activities-body"></tbody>
        </table>
        <button id="add-activity-btn" onclick="addActivityRow()">➕ Add Row</button>
        <div style="text-align: center;">
            <button onclick="saveActivities()">Save Activities</button>
        </div>
    </div>
</div>

<div id="costing-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeCostingPopup()">×</span>
        <h3 style="text-align: center;">Project Costing 💰</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">Costing for Work Order: <span id="costing-wo-number-display"></span></p>
        <table id="costing-table">
            <thead>
                <tr>
                    <th>Particulars</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Unit Cost</th>
                    <th>Total</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="costing-body"></tbody>
        </table>
        <div style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 12pt;">
            Grand Total: <span id="grand-total">₱0.00</span>
        </div>
        <button id="add-costing-row-btn" onclick="addCostingRow()">➕ Add Row</button>
        <div style="text-align: center;">
            <button onclick="saveCosting()">Save Costing</button>
        </div>
    </div>
</div>

<div id="master-print-preview-popup" class="popup-overlay">
    <div class="popup-content" style="max-width: 8.5in;">
        <span class="close-btn" onclick="closeMasterPrintPreview()">×</span>
        <h3 style="text-align: center;">Master Print Preview</h3>
        <div id="master-print-preview-content" style="height: 70vh; overflow-y: auto; border: 1px solid #ccc; padding: 15px; background: white;">
            </div>
        <div style="text-align: center; margin-top: 15px;">
            <button onclick="executeMasterPrint()">🖨️ Print</button>
        </div>
    </div>
</div>

<div id="status-remarks-popup-overlay" class="popup-overlay">
    <div class="popup-content" style="max-width: 500px;">
        <span class="close-btn" onclick="closeStatusRemarksPopup()">×</span>
        <h3 style="text-align: center;">Update Status & Remarks</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">For Work Order: <span id="status-remarks-wo-number-display"></span></p>
        <div class="form-group">
            <label>Status:</label>
            <select id="popup-status-select">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
        <div class="form-group">
            <label>Remarks:</label>
            <textarea id="popup-remarks-textarea" style="height: 100px;"></textarea>
        </div>
        <div style="text-align: center;">
            <button onclick="saveStatusRemarks()">Save Changes</button>
        </div>
    </div>
</div>


<div id="print-summary-container">
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  // Global state
  let editingWoNumber = null;
  let currentFilter = 'All';
  let ganttChart = null;
  let allGanttCharts = [];
  let woNumberForStatusUpdate = null;
  let allWorkOrders = []; // Central cache for all orders

  const API_URL = '/api/work-orders';
  const colors = [
    '#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6',
    '#e67e22', '#1abc9c', '#f39c12', '#d35400', '#c0392b',
    '#2980b9', '#8e44ad', '#34495e', '#7f8c8d', '#27ae60'
  ];

  // Utility functions
  function formatCurrency(number) {
    return new Intl.NumberFormat('en-PH', {
        style: 'currency',
        currency: 'PHP'
    }).format(number);
  }

  function syncRequestor() {
    document.getElementById('printedRequestorName').textContent = document.getElementById('req-party').value || "________________________";
    document.getElementById('printedRequestorPosition').textContent = document.getElementById('req-position').value || "________________________";
  }

  // Password and Initialization
  window.addEventListener('DOMContentLoaded', () => {
      // The password overlay now just hides the dashboard, no localStorage flag needed.
      const passwordInput = document.getElementById("system-password");
      const enterButton = document.getElementById("enter-button");

      function tryLogin() {
          const input = passwordInput.value;
          // Simple password check. In a real app, this should be done on the server.
          if (input === "admin123") {
              document.getElementById("password-overlay").style.display = "none";
              document.getElementById("dashboard").classList.remove('hidden-by-password');
              document.getElementById("dashboard").style.display = 'block';
              initializeDashboard();
          } else {
              alert("Incorrect password");
          }
      }

      enterButton.addEventListener("click", tryLogin);
      passwordInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") tryLogin();
      });

      // Automatically focus password field
      passwordInput.focus();
      addMaterialRow();
  });

  async function initializeDashboard() {
      await fetchAllWorkOrders();
      populateWorkOrderList('All');
      updateDashboardStats();
      updateLastWoNumberDisplays();
  }

  async function fetchAllWorkOrders() {
      try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error('Failed to fetch work orders');
          allWorkOrders = await response.json();
      } catch (error) {
          console.error("Fetch Error:", error);
          alert("Could not load work orders from the server.");
          allWorkOrders = [];
      }
  }

  // Dashboard UI updates
  function updateDashboardStats() {
      let pending = 0, inProgress = 0, completed = 0;
      allWorkOrders.forEach(order => {
          if (order.status === 'Pending') pending++;
          else if (order.status === 'In Progress') inProgress++;
          else if (order.status === 'Completed') completed++;
      });

      document.getElementById('pending-count').textContent = pending;
      document.getElementById('inprogress-count').textContent = inProgress;
      document.getElementById('completed-count').textContent = completed;
  }

  function updateLastWoNumberDisplays() {
      const lastWoSpanPopup = document.getElementById('last-wo-in-popup');
      if (allWorkOrders.length === 0) {
          lastWoSpanPopup.textContent = 'N/A';
          return;
      }

      let lastWoNumber = '';
      let maxNumericPart = -1;

      allWorkOrders.forEach(order => {
          const numericPart = parseInt(order.woNumber.replace(/\D/g, ''), 10);
          if (!isNaN(numericPart) && numericPart > maxNumericPart) {
              maxNumericPart = numericPart;
              lastWoNumber = order.woNumber;
          }
      });
      lastWoSpanPopup.textContent = lastWoNumber || 'N/A';
  }

  // Data Manipulation (CRUD)
  async function saveWorkOrder() {
      const woNumber = document.getElementById('wo-number').value.trim();
      if (!woNumber) return alert("WO Number is required.");

      const order = {
          woNumber,
          reqParty: document.getElementById('req-party').value,
          reqPosition: document.getElementById('req-position').value,
          building: document.getElementById('building').value,
          dateRequested: document.getElementById('date-requested').value,
          dateStarted: document.getElementById('date-started').value,
          estimateDateAccomplished: document.getElementById('estimate-date-accomplished').value,
          description: document.getElementById('description').value,
          status: document.getElementById('status').value,
          remarks: document.getElementById('remarks').value,
          technician: document.getElementById('performed-by').value,
          materials: getMaterialRows(),
          concurredBy: document.getElementById('concurred-by-select').value,
          concurredByTitle: document.getElementById('concurred-by-title').textContent,
          // Get existing data if editing, otherwise initialize as empty
          evidence: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.evidence || []) : [],
          activities: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.activities || []) : [],
          costing: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.costing || []) : [],
          savedAt: new Date().toLocaleString()
      };

      try {
          let response;
          if (editingWoNumber) {
              // Update existing order
              response = await fetch(`${API_URL}/${editingWoNumber}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(order)
              });
          } else {
              // Create new order
              response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(order)
              });
          }

          if (response.status === 409) {
              return showDuplicateAlert();
          }
          if (!response.ok) {
              const err = await response.json();
              throw new Error(err.message || 'Server error');
          }

          alert("Work Order saved successfully!");
          closeNewOrderPopup();
          await initializeDashboard(); // Refresh all data from server

      } catch (error) {
          console.error("Save Error:", error);
          alert(`Error saving work order: ${error.message}`);
      }
  }

  async function deleteWorkOrder(woNumber) {
    const pass = prompt("Enter password to delete:");
    if (pass !== 'admin123') return alert("Incorrect password");

    if (!confirm(`Are you sure you want to delete Work Order #${woNumber}?`)) return;

    try {
        const response = await fetch(`${API_URL}/${woNumber}`, { method: 'DELETE' });
        if (!response.ok && response.status !== 204) {
            throw new Error('Failed to delete on server.');
        }

        alert("Deleted successfully.");
        document.getElementById('selected-wo-details-section').style.display = 'none';
        await initializeDashboard(); // Refresh data

    } catch (error) {
        console.error("Delete Error:", error);
        alert("Error deleting work order.");
    }
}

  // Populating Lists and Details
  function populateWorkOrderList(filterStatus, ordersToDisplay = null) {
      currentFilter = filterStatus;
      let orders = ordersToDisplay;
      if (!orders) {
          orders = allWorkOrders.filter(entry => filterStatus === 'All' || entry.status === filterStatus);
      }

      orders.sort((a, b) => {
          const numA = parseInt(a.woNumber.replace(/\D/g, ''), 10) || 0;
          const numB = parseInt(b.woNumber.replace(/\D/g, ''), 10) || 0;
          return numA - numB;
      });

      const container = document.getElementById('wo-list');
      container.innerHTML = '';

      if (orders.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #888;">No work orders found.</p>';
          return;
      }

      orders.forEach(entry => {
          const div = document.createElement('div');
          div.className = 'wo-btn';
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.innerHTML = `
            <div onclick="displayWorkOrderDetails('${entry.woNumber}')" style="cursor: pointer; flex-grow: 1;">
                <strong>WO#:</strong> ${entry.woNumber} | <strong>Status:</strong> ${entry.status}<br>
                <strong>Party:</strong> ${entry.reqParty}<br>
                <strong>Date:</strong> ${entry.dateRequested}
            </div>
            <button onclick="openStatusRemarksPopup('${entry.woNumber}', event)" style="margin-left: 10px; padding: 5px 10px; font-size: 10pt;">Edit Status</button>
          `;
          container.appendChild(div);
      });
  }

    function loadWorkOrder(woNumber) {
      const pass = prompt("Enter password to edit:");
      if (pass !== 'admin123') return alert("Incorrect password");
      const order = allWorkOrders.find(o => o.woNumber === woNumber);
      if (!order) return alert('Work order not found.');

      clearAllFields();
      editingWoNumber = woNumber;

      document.getElementById('wo-number').value = order.woNumber;
      document.getElementById('req-party').value = order.reqParty;
      document.getElementById('req-position').value = order.reqPosition;
      document.getElementById('building').value = order.building;
      document.getElementById('date-requested').value = order.dateRequested;
      document.getElementById('date-started').value = order.dateStarted;
      document.getElementById('estimate-date-accomplished').value = order.estimateDateAccomplished || '';
      document.getElementById('description').value = order.description;
      document.getElementById('status').value = order.status;
      document.getElementById('remarks').value = order.remarks;
      document.getElementById('performed-by').value = order.technician || '';
      setMaterialRows(order.materials);
      setActivities(order.activities);
      syncRequestor();
      document.getElementById('concurred-by-select').value = order.concurredBy;
      updateConcurredBy();

      openNewOrderPopup();
  }

  function displayWorkOrderDetails(woNumber) {
    const order = allWorkOrders.find(o => o.woNumber === woNumber);

    if (!order) {
        alert('Work order not found.');
        return;
    }

    editingWoNumber = woNumber;

    document.getElementById('all-gantt-charts-section').style.display = 'none';
    const detailsSection = document.getElementById('selected-wo-details-section');
    detailsSection.style.display = 'block';

    document.getElementById('detail-wo-number').textContent = order.woNumber;
    document.getElementById('detail-req-party').textContent = order.reqParty;
    document.getElementById('detail-req-position').textContent = order.reqPosition;
    document.getElementById('detail-building').textContent = order.building;
    document.getElementById('detail-date-requested').textContent = order.dateRequested;
    document.getElementById('detail-date-started').textContent = order.dateStarted;
    document.getElementById('detail-date-accomplished').textContent = order.estimateDateAccomplished || 'N/A';
    document.getElementById('detail-status').textContent = order.status;

    let totalCost = 0;
    if (order.costing && Array.isArray(order.costing)) {
        order.costing.forEach(item => {
            totalCost += parseFloat(item.total) || 0;
        });
    }
    document.getElementById('detail-total-cost').textContent = formatCurrency(totalCost);

    document.getElementById('edit-button').onclick = () => loadWorkOrder(woNumber);
    document.getElementById('print-button').onclick = () => printSpecificWorkOrder(woNumber);
    document.getElementById('delete-button').onclick = () => deleteWorkOrder(woNumber);
    document.getElementById('view-activities-button').onclick = () => showActivitiesPopup(order.activities);
    document.getElementById('edit-activities-button').onclick = () => showActivitiesTablePopup(order.activities);
    document.getElementById('costing-button').onclick = () => openCostingPopup(woNumber);

    // Render Evidence
    renderEvidence(woNumber, order.evidence || []);

    renderGanttChart(order);
  }

    // Evidence Handling
    function renderEvidence(woNumber, evidenceArray) {
        const evidencePreviewContainer = document.getElementById('evidence-preview-details');
        evidencePreviewContainer.innerHTML = ''; // Clear previous images

        if (Array.isArray(evidenceArray) && evidenceArray.length > 0) {
            evidenceArray.forEach((imgData, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.style.position = 'relative';
                imgWrapper.style.margin = '5px';

                const img = document.createElement('img');
                img.src = imgData;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '5px';
                img.style.cursor = 'pointer';
                img.onclick = () => openImagePreview(imgData);

                const deleteBtn = document.createElement('span');
                deleteBtn.innerHTML = '×';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-5px';
                deleteBtn.style.right = '-5px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.background = 'rgba(255,0,0,0.8)';
                deleteBtn.style.color = 'white';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.textAlign = 'center';
                deleteBtn.style.lineHeight = '20px';
                deleteBtn.style.fontWeight = 'bold';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteEvidence(woNumber, index);
                };

                imgWrapper.appendChild(img);
                imgWrapper.appendChild(deleteBtn);
                evidencePreviewContainer.appendChild(imgWrapper);
            });
        }
        document.getElementById('add-evidence-button').onclick = () => addEvidence(woNumber);
    }

    async function addEvidence(woNumber) {
        const files = document.getElementById('evidence-upload-details').files;
        if (files.length === 0) return alert('Please select one or more images to upload.');

        let order = allWorkOrders.find(o => o.woNumber === woNumber);
        if (!order) return alert('Error: Work order not found.');

        const filePromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        });

        try {
            const base64Images = await Promise.all(filePromises);
            if (!Array.isArray(order.evidence)) {
                order.evidence = [];
            }
            order.evidence.push(...base64Images);

            // Save the updated order back to the server
            const response = await fetch(`${API_URL}/${woNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to save evidence to server.');

            alert(`${base64Images.length} image(s) added successfully!`);
            document.getElementById('evidence-upload-details').value = '';
            await fetchAllWorkOrders(); // Re-fetch to get the latest state
            displayWorkOrderDetails(woNumber); // Refresh view

        } catch (error) {
            console.error("Error adding evidence: ", error);
            alert("There was an error uploading the images.");
        }
    }

    async function deleteEvidence(woNumber, index) {
        if (!confirm('Are you sure you want to delete this image?')) return;

        let order = allWorkOrders.find(o => o.woNumber === woNumber);
        if (!order || !order.evidence || !order.evidence[index]) return;

        order.evidence.splice(index, 1); // Remove the image

        try {
            // Save the updated order back to the server
            const response = await fetch(`${API_URL}/${woNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to update evidence on server.');

            await fetchAllWorkOrders(); // Re-fetch to get the latest state
            displayWorkOrderDetails(woNumber); // Refresh view

        } catch (error) {
            console.error("Error deleting evidence:", error);
            alert("Failed to delete evidence.");
        }
    }

  // Other UI functions (Popups, printing, etc.) - Most of these can remain the same
  function openWorkOrderList(filterStatus = 'All') {
    document.getElementById('selected-wo-details-section').style.display = 'none';
    document.getElementById('all-gantt-charts-section').style.display = 'none';
    populateWorkOrderList(filterStatus);
  }

  function searchWorkOrders() {
      const searchTerm = document.getElementById('wo-search').value.toLowerCase();
      const filteredOrders = allWorkOrders.filter(order => order.woNumber.toLowerCase().includes(searchTerm));
      populateWorkOrderList(null, filteredOrders);
  }

  function openImagePreview(src) {
    document.getElementById('preview-img').src = src;
    document.getElementById('image-preview-overlay').style.display = 'flex';
  }

  function closeImagePreview() {
    document.getElementById('image-preview-overlay').style.display = 'none';
  }

  function showDuplicateAlert() {
    document.getElementById('duplicate-alert').style.display = 'flex';
    document.getElementById('alert-sound').play();
    setTimeout(() => hideDuplicateAlert(), 5000);
  }

  function hideDuplicateAlert() {
    document.getElementById('duplicate-alert').style.display = 'none';
  }

  function clearAllFields() {
    const ids = ['wo-number', 'req-party', 'req-position', 'building', 'date-requested', 'date-started', 'estimate-date-accomplished'];
    ids.forEach(id => document.getElementById(id).value = '');
    document.getElementById('description').value = '';
    document.getElementById('remarks').value = '';
    document.getElementById('performed-by').value = '';
    document.getElementById('materials-body').innerHTML = '';
    addMaterialRow();
    document.getElementById('activities-body').innerHTML = '';
    addActivityRow();
    syncRequestor();
    editingWoNumber = null;
    document.getElementById('concurred-by-select').value = "ENGR. GLENN D. LUNA, REE, MBA";
    updateConcurredBy();
    document.getElementById('status').value = "Pending";
  }

    // The rest of your UI and helper functions (addMaterialRow, printCurrentForm, renderGanttChart, etc.)
    // do not need significant changes as they mostly deal with the DOM.
    // I am including them here for completeness.

  function addMaterialRow() {
    const tbody = document.getElementById('materials-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" class="room"></td>
      <td><input type="text" class="qty"></td>
      <td><input type="text" class="particular"></td>
      <td><input type="checkbox" class="avail"></td>
      <td><input type="checkbox" class="notavail"></td>
      <td class="delete-column"><button onclick="deleteMaterialRow(this)">🗑️</button></td>
    `;
    tbody.appendChild(row);
  }

  function getMaterialRows() {
    return Array.from(document.querySelectorAll('#materials-body tr')).map(row => ({
      room: row.querySelector('.room')?.value || '',
      qty: row.querySelector('.qty')?.value || '',
      particular: row.querySelector('.particular')?.value || '',
      avail: row.querySelector('.avail')?.checked || false,
      notavail: row.querySelector('.notavail')?.checked || false
    }));
  }

  function setMaterialRows(materials) {
    const tbody = document.getElementById('materials-body');
    tbody.innerHTML = '';
    if (materials && materials.length > 0) {
      materials.forEach(() => addMaterialRow());
      const rows = document.querySelectorAll('#materials-body tr');
      materials.forEach((item, i) => {
        if (rows[i]) {
          rows[i].querySelector('.qty').value = item.qty;
          rows[i].querySelector('.room').value = item.room;
          rows[i].querySelector('.particular').value = item.particular;
          rows[i].querySelector('.avail').checked = item.avail;
          rows[i].querySelector('.notavail').checked = item.notavail;
        }
      });
    } else {
        addMaterialRow();
    }
  }

  function deleteMaterialRow(button) {
    const row = button.closest('tr');
    row.remove();
  }

  function updateConcurredBy() {
      const select = document.getElementById('concurred-by-select');
      const selectedOption = select.options[select.selectedIndex];
      const titleSpan = document.getElementById('concurred-by-title');
      titleSpan.textContent = selectedOption.dataset.title;
  }

  function populatePrintTemplate(order, suffix) {
      document.getElementById('print-wo-number' + suffix).textContent = order.woNumber;
      document.getElementById('print-req-party' + suffix).textContent = order.reqParty;
      document.getElementById('print-req-position' + suffix).textContent = order.reqPosition;
      document.getElementById('print-building' + suffix).textContent = order.building;
      document.getElementById('print-date-requested' + suffix).textContent = order.dateRequested;
      document.getElementById('print-date-started' + suffix).textContent = order.dateStarted;
      document.getElementById('print-estimate-date-accomplished' + suffix).textContent = order.estimateDateAccomplished || '';
      document.getElementById('print-description' + suffix).textContent = order.description;
      document.getElementById('print-status' + suffix).textContent = order.status;
      document.getElementById('print-remarks' + suffix).textContent = order.remarks;
      document.getElementById('print-performed-by' + suffix).textContent = order.technician || '________________________';
      document.getElementById('print-printedRequestorName' + suffix).textContent = order.reqParty || '________________________';
      document.getElementById('print-printedRequestorPosition' + suffix).textContent = order.reqPosition || '________________________';
      document.getElementById('print-concurred-by-name' + suffix).textContent = order.concurredBy;
      document.getElementById('print-concurred-by-title' + suffix).textContent = order.concurredByTitle;
      const printMaterialsBody = document.getElementById('print-materials-body' + suffix);
      printMaterialsBody.innerHTML = '';
      if (order.materials) {
          order.materials.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.room}</td><td>${item.qty}</td><td>${item.particular}</td><td>${item.avail ? '✔️' : ''}</td><td>${item.notavail ? '❌' : ''}</td>`;
            printMaterialsBody.appendChild(row);
          });
      }
      const printEvidenceDiv = document.getElementById('print-evidence' + suffix);
      const firstEvidence = Array.isArray(order.evidence) ? order.evidence[0] : order.evidence;
      if (firstEvidence) {
          printEvidenceDiv.innerHTML = `<img src="${firstEvidence}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          printEvidenceDiv.style.display = 'block';
      } else {
          printEvidenceDiv.innerHTML = '';
          printEvidenceDiv.style.display = 'none';
      }
  }

  function printCurrentForm() {
      const currentOrder = {
        woNumber: document.getElementById('wo-number').value,
        reqParty: document.getElementById('req-party').value,
        reqPosition: document.getElementById('req-position').value,
        building: document.getElementById('building').value,
        dateRequested: document.getElementById('date-requested').value,
        dateStarted: document.getElementById('date-started').value,
        estimateDateAccomplished: document.getElementById('estimate-date-accomplished').value,
        description: document.getElementById('description').value,
        status: document.getElementById('status').value,
        remarks: document.getElementById('remarks').value,
        technician: document.getElementById('performed-by').value,
        materials: getMaterialRows(),
        evidence: [],
        concurredBy: document.getElementById('concurred-by-select').value,
        concurredByTitle: document.getElementById('concurred-by-title').textContent,
        activities: getActivities(),
      };
      populatePrintTemplate(currentOrder, '-1');
      populatePrintTemplate(currentOrder, '-2');
      setTimeout(() => window.print(), 100);
  }

  function printSpecificWorkOrder(woNumber) {
      const order = allWorkOrders.find(o => o.woNumber === woNumber);
      if (!order) return alert('Work order not found.');
      populatePrintTemplate(order, '-1');
      populatePrintTemplate(order, '-2');
      setTimeout(() => window.print(), 100);
  }

  function printSummary() {
      const orders = [...allWorkOrders];
      if (orders.length === 0) return alert("No work orders to print.");
      orders.sort((a, b) => (parseInt(a.woNumber.replace(/\D/g, '')) || 0) - (parseInt(b.woNumber.replace(/\D/g, '')) || 0));
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Work Order Summary</title><style>body{font-family:Arial,sans-serif;margin:20px}.header{overflow:hidden;margin-bottom:5px}.header img{width:70px}.header img.left{float:left}.header img.right{float:right}.header .university-info{text-align:center}h3{margin:0;font-size:12pt}p{margin:0;font-size:8pt}hr{border:none;height:2px;background-color:#000;margin:3px 0}h2{text-align:center;margin-top:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #000;padding:8px;text-align:left;font-size:10pt}</style></head><body>');
      printWindow.document.write(`<div class="header"><img src="images/UCV.png" alt="logo" class="left"><img src="images/oppm_logo.png" alt="logo" class="right"><div class="university-info"><h3>UNIVERSITY OF CAGAYAN VALLEY</h3><p>Victor Ventura Perez (VVP) Campus<br>Tuguegarao City<br>(078) 844-8978 | Fax: (078) 844-0086</p><p>OFFICE OF THE PHYSICAL PLANT AND MAINTENANCE</p><hr></div></div><h2>Work Order Summary Report</h2><table><thead><tr><th>WO#</th><th>Requesting Party</th><th>Building</th><th>Date Requested</th><th>Status</th></tr></thead><tbody>`);
      orders.forEach(order => {
        printWindow.document.write(`<tr><td>${order.woNumber}</td><td>${order.reqParty}</td><td>${order.building}</td><td>${order.dateRequested}</td><td>${order.status}</td></tr>`);
      });
      printWindow.document.write('</tbody></table></body></html>');
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
  }

    async function saveActivities() {
      if (!editingWoNumber) return alert("No work order selected.");

      const order = allWorkOrders.find(o => o.woNumber === editingWoNumber);
      if (!order) return alert("Work order not found.");

      order.activities = getActivities();

      try {
          const response = await fetch(`${API_URL}/${editingWoNumber}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(order)
          });
          if (!response.ok) throw new Error('Failed to save activities.');
          alert("Activities saved successfully!");
          closeActivitiesTablePopup();
          await fetchAllWorkOrders();
          displayWorkOrderDetails(editingWoNumber);
      } catch (error) {
          alert(`Error saving activities: ${error.message}`);
      }
  }

    async function saveCosting() {
        if (!editingWoNumber) return alert("No work order selected.");
        const order = allWorkOrders.find(o => o.woNumber === editingWoNumber);
        if (!order) return alert("Work order not found.");

        order.costing = Array.from(document.querySelectorAll('#costing-body tr')).map(row => {
            const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0;
            const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0;
            return {
                particular: row.querySelector('.cost-particular').value,
                quantity: row.querySelector('.cost-quantity').value,
                unit: row.querySelector('.cost-unit').value,
                unitCost: row.querySelector('.cost-unit-cost').value,
                total: (quantity * unitCost).toFixed(2)
            }
        });

        try {
            const response = await fetch(`${API_URL}/${editingWoNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to save costing.');
            alert("Costing data saved successfully!");
            closeCostingPopup();
            await fetchAllWorkOrders();
            displayWorkOrderDetails(editingWoNumber);
        } catch (error) {
            alert(`Error saving costing: ${error.message}`);
        }
    }

    async function saveStatusRemarks() {
        const order = allWorkOrders.find(o => o.woNumber === woNumberForStatusUpdate);
        if(!order) return alert("Work order not found.");

        order.status = document.getElementById('popup-status-select').value;
        order.remarks = document.getElementById('popup-remarks-textarea').value;

        try {
            const response = await fetch(`${API_URL}/${woNumberForStatusUpdate}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if(!response.ok) throw new Error('Failed to update status.');

            closeStatusRemarksPopup();
            await fetchAllWorkOrders(); // Refresh all data
            populateWorkOrderList(currentFilter);
            updateDashboardStats();
            if (editingWoNumber === woNumberForStatusUpdate) {
                displayWorkOrderDetails(woNumberForStatusUpdate);
            }
        } catch (error) {
            alert(`Error updating status: ${error.message}`);
        }
    }


    // The following functions are mostly unchanged as they handle local UI logic.
    function renderGanttChart(order) { if (ganttChart) { ganttChart.destroy(); } const ctx = document.getElementById('wo-gantt-canvas').getContext('2d'); const validActivities = (order.activities || []).filter(a => a.startDate && a.endDate); if (validActivities.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center"; ctx.fillText("No activities with timelines to display.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const datasets = []; let minDate = new Date('2999-12-31'); let maxDate = new Date('1970-01-01'); validActivities.forEach((activity, index) => { const activityData = []; const startDate = new Date(activity.startDate); const endDate = new Date(activity.endDate); if (startDate.getTime() > maxDate.getTime()) maxDate = new Date(startDate); if (endDate.getTime() > maxDate.getTime()) maxDate = new Date(endDate); if (startDate.getTime() < minDate.getTime()) minDate = new Date(startDate); let currentDate = new Date(startDate); while (currentDate <= endDate) { activityData.push({ x: new Date(currentDate), y: activity.name || 'Untitled Activity', r: 10 }); currentDate.setDate(currentDate.getDate() + 1); } datasets.push({ label: activity.name || 'Untitled Activity', data: activityData, backgroundColor: colors[index % colors.length], pointStyle: 'rect', radius: 10, }); }); maxDate.setDate(maxDate.getDate() + 1); minDate.setDate(minDate.getDate() - 1); ganttChart = new Chart(ctx, { type: 'bubble', data: { datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (context) => context[0].dataset.label, label: (context) => `Date: ${new Date(context.raw.x).toLocaleDateString()}` } } }, scales: { y: { type: 'category', labels: validActivities.map(a => a.name || 'Untitled Activity'), offset: true, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } }, x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MMM d' } }, min: minDate, max: maxDate, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' }, ticks: { source: 'auto' } } } } }); }
    function openNewOrderPopup() { document.getElementById('new-order-popup').style.display = 'flex'; }
    function closeNewOrderPopup() { document.getElementById('new-order-popup').style.display = 'none'; }
    function showTablePopup() { document.getElementById('table-popup-overlay').style.display = 'flex'; }
    function closeTablePopup() { document.getElementById('table-popup-overlay').style.display = 'none'; }
    function showActivitiesTablePopup(activities) { if (editingWoNumber === null) { alert("Please select a work order first."); return; } document.getElementById('activities-wo-number-display').textContent = editingWoNumber; setActivities(activities); document.getElementById('activities-table-popup-overlay').style.display = 'flex'; }
    function closeActivitiesTablePopup() { document.getElementById('activities-table-popup-overlay').style.display = 'none'; }
    function addActivityRow() { const tbody = document.getElementById('activities-body'); const row = document.createElement('tr'); row.innerHTML = `<td><input type="text" class="activity-name"></td><td><input type="date" class="activity-start-date"></td><td><input type="date" class="activity-end-date"></td><td class="delete-column"><button onclick="deleteActivityRow(this)">🗑️</button></td>`; tbody.appendChild(row); }
    function deleteActivityRow(button) { const row = button.closest('tr'); row.remove(); }
    function getActivities() { return Array.from(document.querySelectorAll('#activities-body tr')).map(row => ({ name: row.querySelector('.activity-name')?.value || '', startDate: row.querySelector('.activity-start-date')?.value || '', endDate: row.querySelector('.activity-end-date')?.value || '' })); }
    function setActivities(activities) { const tbody = document.getElementById('activities-body'); tbody.innerHTML = ''; if (activities && activities.length > 0) { activities.forEach(activity => { const row = document.createElement('tr'); row.innerHTML = `<td><input type="text" class="activity-name" value="${activity.name || ''}"></td><td><input type="date" class="activity-start-date" value="${activity.startDate || ''}"></td><td><input type="date" class="activity-end-date" value="${activity.endDate || ''}"></td><td class="delete-column"><button onclick="deleteActivityRow(this)">🗑️</button></td>`; tbody.appendChild(row); }); } else { addActivityRow(); } }
    function showActivitiesPopup(activities) { const popupContent = document.getElementById('activities-list'); popupContent.innerHTML = ''; if (activities && activities.length > 0 && activities.some(a => a.name)) { activities.forEach((activity, index) => { if(!activity.name) return; const activityDiv = document.createElement('div'); activityDiv.classList.add('activity-item'); activityDiv.innerHTML = `<p><strong>Activity ${index + 1}:</strong> ${activity.name}</p><p><strong>Date Start:</strong> ${activity.startDate || 'N/A'}</p><p><strong>Date End:</strong> ${activity.endDate || 'N/A'}</p><hr>`; popupContent.appendChild(activityDiv); }); } else { popupContent.innerHTML = '<p>No activities recorded for this work order.</p>'; } document.getElementById('activities-popup-overlay').style.display = 'flex'; }
    function closeActivitiesPopup() { document.getElementById('activities-popup-overlay').style.display = 'none'; }
    function openAboutPopup() { document.getElementById('about-popup').style.display = 'flex'; }
    function closeAboutPopup() { document.getElementById('about-popup').style.display = 'none'; }
    function openCostingPopup(woNumber) { if (!editingWoNumber) { alert("Please select a work order first."); return; } document.getElementById('costing-wo-number-display').textContent = editingWoNumber; const order = allWorkOrders.find(o => o.woNumber === editingWoNumber); setCostingRows(order.costing); document.getElementById('costing-popup-overlay').style.display = 'flex'; }
    function closeCostingPopup() { document.getElementById('costing-popup-overlay').style.display = 'none'; }
    function addCostingRow(item = {}) { const tbody = document.getElementById('costing-body'); const row = document.createElement('tr'); const total = (parseFloat(item.quantity) || 0) * (parseFloat(item.unitCost) || 0); row.innerHTML = `<td><input type="text" class="cost-particular" value="${item.particular || ''}"></td><td><input type="number" class="cost-quantity" value="${item.quantity || ''}" oninput="calculateRowTotal(this.closest('tr'))"></td><td><input type="text" class="cost-unit" value="${item.unit || ''}"></td><td><input type="number" class="cost-unit-cost" value="${item.unitCost || ''}" oninput="calculateRowTotal(this.closest('tr'))"></td><td class="cost-total">${formatCurrency(total)}</td><td class="delete-column"><button onclick="deleteCostingRow(this)">🗑️</button></td>`; tbody.appendChild(row); }
    function deleteCostingRow(button) { button.closest('tr').remove(); updateGrandTotal(); }
    function calculateRowTotal(row) { const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0; const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0; const total = quantity * unitCost; row.querySelector('.cost-total').textContent = formatCurrency(total); updateGrandTotal(); }
    function updateGrandTotal() { let grandTotal = 0; document.querySelectorAll('#costing-body tr').forEach(row => { const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0; const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0; grandTotal += quantity * unitCost; }); document.getElementById('grand-total').textContent = formatCurrency(grandTotal); }
    function setCostingRows(costingData) { const tbody = document.getElementById('costing-body'); tbody.innerHTML = ''; if (costingData && costingData.length > 0) { costingData.forEach(item => addCostingRow(item)); } else { addCostingRow(); } updateGrandTotal(); }
    function showMasterPrintPreview() { const woNumber = editingWoNumber; if (!woNumber) { alert("Please select a work order first."); return; } const order = allWorkOrders.find(o => o.woNumber === woNumber); if (!order) { alert('Work order not found.'); return; } let previewHtml = ''; const headerClone = document.querySelector('.dashboard-header').cloneNode(true); const pTags = headerClone.querySelectorAll('p'); pTags.forEach(p => { if(p.textContent.includes('DASHBOARD')) p.remove(); }); const leftLogo = headerClone.querySelector('img[style*="left"]'); const rightLogo = headerClone.querySelector('img[style*="right"]'); const headerText = `<div class="header-text">${headerClone.querySelector('h2').outerHTML}${headerClone.querySelector('p').outerHTML}</div>`; previewHtml += `<div class="header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 30px;">${leftLogo ? leftLogo.outerHTML : '<div></div>'}${headerText}${rightLogo ? rightLogo.outerHTML : '<div></div>'}</div>`; const detailsSectionClone = document.getElementById('selected-wo-details-section').cloneNode(true); detailsSectionClone.querySelector('.details-actions').remove(); if (detailsSectionClone.querySelector('#evidence-section')) { detailsSectionClone.querySelector('#evidence-section').remove(); } const ganttCanvas = document.getElementById('wo-gantt-canvas'); const ganttImage = ganttCanvas.toDataURL('image/png'); detailsSectionClone.querySelector('.wo-gantt-section').innerHTML = '<h4>Gantt Chart Timeline</h4><div class="gantt-container" style="width: 100%; margin-top: 15px;"><img src="' + ganttImage + '" style="max-width: 100%; border: 1px solid #eee;"></div>'; previewHtml += '<div class="print-section" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">' + detailsSectionClone.innerHTML; const signatoriesHtml = `<div class="signatories" style="display: flex; justify-content: space-around; margin-top: 70px; text-align: center; width: 100%; page-break-inside: avoid;"><div class="signature-box" style="width: 45%;"><strong>Performed by:</strong><br><br>${order.technician || 'N/A'}</p></div><div class="signature-box" style="width: 45%;"><strong>Requesting Party:</strong><br><br>${order.reqParty}</p></div></div><div class="signatories" style="margin-top: 50px; display: flex; justify-content: space-around; text-align: center; width: 100%; page-break-inside: avoid;"><div class="signature-box" style="margin: auto; width: 45%;"><strong>Concurred by:</strong><br><br>${order.concurredBy}</p></div></div>`; previewHtml += signatoriesHtml + '</div>'; if (order.costing && order.costing.length > 0) { previewHtml += '<div class="print-section" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">'; previewHtml += '<h2>Project Costing</h2>'; previewHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 10pt;"><thead><tr><th style="border: 1px solid #000; padding: 5px;">Particulars</th><th style="border: 1px solid #000; padding: 5px;">Quantity</th><th style="border: 1px solid #000; padding: 5px;">Unit</th><th style="border: 1px solid #000; padding: 5px;">Unit Cost</th><th style="border: 1px solid #000; padding: 5px;">Total</th></tr></thead><tbody>'; let grandTotal = 0; order.costing.forEach(item => { const itemTotal = parseFloat(item.total) || 0; grandTotal += itemTotal; previewHtml += `<tr><td style="border: 1px solid #000; padding: 5px;">${item.particular}</td><td style="border: 1px solid #000; padding: 5px;">${item.quantity}</td><td style="border: 1px solid #000; padding: 5px;">${item.unit}</td><td style="border: 1px solid #000; padding: 5px;">${formatCurrency(parseFloat(item.unitCost) || 0)}</td><td style="border: 1px solid #000; padding: 5px;">${formatCurrency(itemTotal)}</td></tr>`; }); previewHtml += '</tbody></table>'; previewHtml += `<div style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 12pt;">Grand Total: ${formatCurrency(grandTotal)}</div>`; previewHtml += '</div>'; } if (order.evidence && order.evidence.length > 0) { previewHtml += '<div class="print-section" style="page-break-before: always; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">'; previewHtml += '<h2>Picture Evidences</h2>'; previewHtml += '<div class="evidence-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;">'; order.evidence.forEach(imgData => { previewHtml += `<img src="${imgData}" style="width: 6cm; height: 8cm; object-fit: cover; border: 1px solid #ccc; padding: 4px; border-radius: 4px;">`; }); previewHtml += '</div></div>'; } document.getElementById('master-print-preview-content').innerHTML = previewHtml; document.getElementById('master-print-preview-popup').style.display = 'flex'; }
    function closeMasterPrintPreview() { document.getElementById('master-print-preview-popup').style.display = 'none'; }
    function executeMasterPrint() { const printContent = document.getElementById('master-print-preview-content').innerHTML; const printWindow = window.open('', '', 'height=800,width=800'); printWindow.document.write('<html><head><title>Work Order Details & Evidence</title>'); const styles = `body { font-family: Arial, sans-serif; margin: 0; padding: 0; } .print-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid; } .print-section:last-of-type { border-bottom: none; } .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 30px; } .header img { width: 90px; height: auto; } .header-text { text-align: center; } .header-text h2, .header-text p { margin: 2px 0; } h2 { text-align: center; margin-bottom: 20px; } .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; margin: 0 auto 20px auto; max-width: 98%; } .details-grid p { margin: 4px 0; font-size: 11pt; border-bottom: 1px dotted #eee; padding-bottom: 4px; } .details-grid strong { display: inline-block; width: 160px; } .signatories { display: flex; justify-content: space-around; margin-top: 70px; text-align: center; width: 100%; page-break-inside: avoid; } .signature-box { width: 45%; } .signature-line { border-top: 1px solid black; margin: 40px 10px 5px 10px; padding-top: 8px; } .evidence-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; } .evidence-container img { width: 6cm; height: 8cm; object-fit: cover; border: 1px solid #ccc; padding: 4px; border-radius: 4px; } .gantt-container { width: 100%; margin-top: 15px; } .gantt-container img { max-width: 100%; border: 1px solid #eee; } table { width: 100%; border-collapse: collapse; font-size: 10pt; } th, td { border: 1px solid #000; padding: 5px; }`; printWindow.document.write('<style>' + styles + '</style>'); printWindow.document.write('<style> @page { size: 8.5in 13in; margin: 10mm; } </style>'); printWindow.document.write('</head><body>'); printWindow.document.write(printContent); printWindow.document.write('</body></html>'); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500); }
    function openStatusRemarksPopup(woNumber, event) { event.stopPropagation(); woNumberForStatusUpdate = woNumber; const order = allWorkOrders.find(o => o.woNumber === woNumber); if (order) { document.getElementById('status-remarks-wo-number-display').textContent = woNumber; document.getElementById('popup-status-select').value = order.status; document.getElementById('popup-remarks-textarea').value = order.remarks || ''; document.getElementById('status-remarks-popup-overlay').style.display = 'flex'; } }
    function closeStatusRemarksPopup() { document.getElementById('status-remarks-popup-overlay').style.display = 'none'; }
    function viewAllGanttCharts() { const orders = allWorkOrders; if (orders.length === 0) { alert("No work orders available to display Gantt charts."); return; } document.getElementById('selected-wo-details-section').style.display = 'none'; const allGanttSection = document.getElementById('all-gantt-charts-section'); allGanttSection.style.display = 'block'; const container = document.getElementById('all-gantt-container'); container.innerHTML = ''; allGanttCharts.forEach(chart => chart.destroy()); allGanttCharts = []; orders.forEach((order, index) => { const card = document.createElement('div'); card.className = 'single-gantt-card'; card.innerHTML = `<h4>WO#: ${order.woNumber} (${order.reqParty})</h4><canvas id="gantt-canvas-${index}"></canvas>`; container.appendChild(card); const ctx = document.getElementById(`gantt-canvas-${index}`).getContext('2d'); const validActivities = (order.activities || []).filter(a => a.startDate && a.endDate); if (validActivities.length === 0) { ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center"; ctx.fillText("No activities to display.", ctx.canvas.width / 2, 75); return; } const datasets = []; let minDate = new Date('2999-12-31'); let maxDate = new Date('1970-01-01'); validActivities.forEach((activity, activityIndex) => { const activityData = []; const startDate = new Date(activity.startDate); const endDate = new Date(activity.endDate); if (startDate.getTime() > maxDate.getTime()) maxDate = new Date(startDate); if (endDate.getTime() > maxDate.getTime()) maxDate = new Date(endDate); if (startDate.getTime() < minDate.getTime()) minDate = new Date(startDate); let currentDate = new Date(startDate); while (currentDate <= endDate) { activityData.push({ x: new Date(currentDate), y: activity.name || 'Untitled Activity', r: 10 }); currentDate.setDate(currentDate.getDate() + 1); } datasets.push({ label: activity.name || 'Untitled Activity', data: activityData, backgroundColor: colors[activityIndex % colors.length], pointStyle: 'rect', radius: 10, }); }); maxDate.setDate(maxDate.getDate() + 1); minDate.setDate(minDate.getDate() - 1); const chart = new Chart(ctx, { type: 'bubble', data: { datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (context) => context[0].dataset.label, label: (context) => `Date: ${new Date(context.raw.x).toLocaleDateString()}` } } }, scales: { y: { type: 'category', labels: validActivities.map(a => a.name || 'Untitled Activity'), offset: true, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } }, x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MMM d' } }, min: minDate, max: maxDate, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } } } } }); allGanttCharts.push(chart); }); }
</script>
</body>
</html>
=======
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Work Order Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('background.jpg');
      background-size: cover;
      color: black; /* Ensuring body text is black */
    }

    /* Form and table styles */
    .form-group {
      margin: 10px 0;
      display: flex;
      align-items: center;
    }
    label {
      display: inline-block;
      width: 180px;
      font-weight: bold;
      font-size: 11pt;
      color: black;
    }
    input, textarea, select {
      flex-grow: 1;
      width: 60%;
      padding: 8px;
      font-size: 11pt;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.7);
      transition: all 0.3s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      color: black;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #6a5acd;
      box-shadow: 0 0 5px rgba(106, 90, 205, 0.5);
      outline: none;
      background: white;
    }
    textarea {
      height: 80px;
      resize: vertical;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 8pt;
      color: black;
    }
    th, td {
      border: 1px solid #000;
      padding: 5px;
      text-align: center;
      font-size: 8pt;
      color: black; /* Explicitly setting table cell color */
    }
    .signatories {
      display: flex;
      justify-content: space-between;
      margin-top: 40px;
      color: black;
    }
    .signature-box {
      text-align: center;
      width: 45%;
    }
    .signature-line {
      border-top: none;
      margin-top: 6px;
      margin-bottom: 6px;
    }
    
    /* Button styles */
    .btn-print button, .main-content button, .dashboard-actions button, .wo-btn button, .details-actions button, #add-evidence-button {
        padding: 8px 16px;
        font-size: 11pt;
        margin: 10px 5px;
        border: none;
        border-radius: 8px;
        background-color: #6a5acd;
        color: white;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .btn-print button:hover, .main-content button:hover, .dashboard-actions button:hover, .wo-btn button:hover, .details-actions button:hover, #add-evidence-button:hover {
        background-color: #5544aa;
        transform: translateY(-2px);
    }
    .wo-btn.edit-btn { background-color: #28a745; }
    .wo-btn.edit-btn:hover { background-color: #218838; }
    .wo-btn.delete-btn { background-color: #dc3545; }
    .wo-btn.delete-btn:hover { background-color: #c82333; }
    .wo-btn.print-btn { background-color: #17a2b8; }
    .wo-btn.print-btn:hover { background-color: #138496; }
    .wo-btn.gantt-btn { background-color: #ffc107; }
    .wo-btn.gantt-btn:hover { background-color: #e0a800; }
    .details-actions { text-align: center; margin-top: 10px; }
    
    /* Other page elements */
    .form-row {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    .form-row .form-group {
      flex: 1;
      display: flex;
      align-items: center;
    }
    .form-row label {
      width: auto;
      min-width: 100px;
      flex-shrink: 0;
      font-size: 11pt;
    }
    .form-row input {
      flex-grow: 1;
      width: auto;
      font-size: 11pt;
    }
    #dashboard.hidden-by-password, #new-order-popup {
        display: none;
    }
    #print-template {
        display: none;
    }
    @media print {
        @page {
            size: 8.5in 13in;
            margin: 0;
        }
        body > *:not(#print-template):not(#print-summary-container):not(#master-print-popup-overlay) {
            display: none !important;
        }
        #master-print-popup-overlay {
            display: block !important;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: auto;
            background: white !important;
            z-index: 99999;
        }
        #master-print-popup-overlay .popup-content {
            box-shadow: none;
            border: none;
            padding: 20px;
            width: 100%;
            max-width: 100%;
        }
        #master-print-popup-overlay .close-btn, 
        #master-print-popup-overlay button {
            display: none !important;
        }
        body {
            margin: 0;
            padding: 0;
            width: 8.5in;
            height: 13in;
            position: relative;
        }
        #print-template, #print-summary-container {
          display: block !important;
          width: 100%;
          height: 100%;
          margin: 0;
          padding: 0;
          position: relative;
          z-index: 1;
        }
        .print-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('background.jpg');
            background-repeat: no-repeat;
            background-position: center center;
            background-size: 300px;
            filter: grayscale(100%);
            opacity: 0.3;
            z-index: -1;
        }
        .print-page {
          width: 100%;
          height: calc(50% - 0.5px);
          box-sizing: border-box;
          padding: 10px;
          position: relative;
          margin-top: 0;
          margin-bottom: 0;
        }
        .print-label {
          position: absolute;
          top: 5px;
          right: 5px;
          font-size: 10pt;
          font-weight: bold;
          color: black;
        }
        input, textarea {
          border: none !important;
          background: none !important;
          color: black !important;
          font-size: 8pt !important;
        }
        .print-page .form-group {
          display: flex;
          align-items: baseline;
          margin: 2px 0;
        }
        .print-page .form-group label {
          width: 120px !important;
          font-size: 8pt !important;
          flex-shrink: 0;
          color: black;
        }
        .print-page .form-group span {
          flex-grow: 1;
          font-size: 8pt !important;
          text-align: left;
          color: black;
        }
        img, .header {
          display: block !important;
        }
        .print-content {
            page-break-inside: avoid;
        }
        .print-page .form-row {
          gap: 5px;
        }
        .print-page table {
          font-size: 8pt;
          margin-top: 5px;
        }
        .print-page th, .print-page td {
          font-size: 8pt;
          color: black;
        }
        .print-page .signature-box span {
          display: block !important;
        }
        .print-page h3, .print-page h4 {
          margin-top: 3px;
          margin-bottom: 10px;
          color: black;
        }
        .print-page .signatories:first-of-type {
          margin-top: 10px;
        }
        .print-page .signatories {
          margin-top: 5px;
        }
        .print-page #print-description-1,
        .print-page #print-remarks-1,
        .print-page #print-description-2,
        .print-page #print-remarks-2 {
            white-space: pre-wrap;
        }
        #evidence-section {
          display: none !important;
        }
        .print-page #print-evidence-1,
        .print-page #print-evidence-2 {
          display: block !important;
          position: absolute;
          bottom: 10px;
          right: 10px;
          width: 192px;
          height: 192px;
        }
        .print-page #print-evidence-1 img,
        .print-page #print-evidence-2 img {
          max-width: 100%;
          max-height: 100%;
          object-fit: contain;
        }
        .dotted-line-separator {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            border-top: 1px dotted black;
        }
    }
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }
    .popup-content {
      background: linear-gradient(rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.95)), url('background.jpg') center center no-repeat;
      background-size: cover, auto;
      padding: 20px;
      border-radius: 5px;
      width: 80%;
      max-width: 900px;
      max-height: 95%;
      position: relative;
      display: flex;
      flex-direction: column;
      color: black;
    }
    .popup-content h3 {
      text-align: center;
      margin-top: 0;
      color: black;
    }
    .popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      z-index: 1;
      color: black;
    }
    .popup-content .minimize-btn {
        position: absolute;
        top: 10px;
        right: 45px; /* Position it to the left of the close button */
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1;
        color: black;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      background-color: white;
      z-index: 100;
      padding: 10px 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .main-content {
      padding-top: 20px;
      overflow-y: auto;
    }
    .popup-header {
      padding-top: 20px;
      margin-bottom: 10px;
      text-align: center;
    }
    .popup-entries-container {
        max-height: 100%;
        overflow-y: auto;
    }
    .signature-img-container {
      position: relative;
      width: 100%;
      height: 60px;
    }
    .signature-img-container img {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        height: 50px;
        object-fit: contain;
        display: none;
    }
    #table-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }
    #table-popup-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      position: relative;
      overflow-y: auto;
      color: black;
    }
    #table-popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
      color: black;
    }
    #materials-table {
        margin-top: 20px;
    }
    #activities-table {
        margin-top: 20px;
    }
    #print-summary-container {
      display: none;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #print-summary-container h2 {
      text-align: center;
      margin-bottom: 20px;
      color: black;
    }
    #print-summary-container table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #print-summary-container th, #print-summary-container td {
      border: 1px solid #000;
      padding: 8px;
      font-size: 10pt;
      color: black;
    }
    #print-summary-container .header {
        overflow: hidden;
        margin-bottom: 5px;
        text-align: center;
    }
    #print-summary-container .header img {
        width: 5000px;
        float: left;
    }
    #print-summary-container .header img.right {
        float: right;
    }
    #duplicate-alert {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(255, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
      color: white;
      font-size: 24px;
      font-weight: bold;
      animation: flashRed 0.5s ease-in-out;
    }
    .alert-content {
      animation: pulse 1s infinite;
    }
    #duplicate-alert button {
      margin-top: 20px;
      padding: 8px 20px;
      font-size: 16px;
      background: white;
      color: red;
      border: none;
      cursor: pointer;
      font-weight: bold;
      border-radius: 5px;
    }
    @keyframes flashRed {
      0%, 100% { background-color: rgba(255, 0, 0, 0.9); }
      50% { background-color: rgba(255, 50, 50, 0.95); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    #password-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: linear-gradient(rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)), url('background.jpg') center center no-repeat;
      background-size: cover, auto;
      z-index: 999999;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      text-align: center;
    }
    #password-overlay-content {
      background: rgba(255, 255, 255, 0.9);
      padding: 40px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(5px);
    }
    #password-overlay h1 {
        font-size: 30px;
        font-weight: bold;
        color: black;
        margin-bottom: 20px;
    }
    #password-overlay input {
      width: 250px;
      padding: 10px;
      font-size: 16px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 5px;
      color: black;
    }
    #password-overlay button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    /* Dashboard Specific Styles */
    #dashboard-container {
        display: flex;
        gap: 20px;
        padding: 20px;
        color: black;
    }
    #work-order-list-container {
        flex: 1;
        min-width: 300px;
    }
    #details-and-gantt-container {
        flex: 2;
    }
    .dashboard-header {
      text-align: center;
      margin-bottom: 20px;
      color: black;
    }
    .stats-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
        gap: 20px;
    }
    .stat-box {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        text-align: center;
        flex: 1;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        color: black;
    }
    .stat-box:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .stat-box h3 {
        margin: 0 0 10px 0;
        font-size: 18px;
        color: black;
    }
    .stat-box p {
        margin: 0;
        font-size: 36px;
        font-weight: bold;
    }
    .dashboard-section {
        background-color: #f9f9f9;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        color: black;
    }
    .dashboard-section h2 {
        text-align: center;
        margin-top: 0;
        color: black;
    }
    .dashboard-actions {
        text-align: center;
        margin-bottom: 20px;
    }
    .wo-list-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px; /* New: Set a maximum height */
      overflow-y: auto; /* New: Enable vertical scrolling */
    }
    .wo-btn {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: left;
      color: black;
    }
    .wo-btn:hover {
      background: #f0f0f0;
    }
    .wo-list-actions {
        display: flex;
        gap: 10px;
        margin-top: 5px;
    }
    .wo-list-actions select, .wo-list-actions input {
        padding: 4px;
        font-size: 9pt;
        border-radius: 5px;
        border: 1px solid #ccc;
    }
    .wo-gantt-section {
        width: 100%;
        margin-top: 20px;
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        height: 250px;
        color: black;
    }
    #wo-gantt-canvas {
        width: 100% !important;
        height: 100% !important;
    }
    #selected-wo-details-section {
      display: none; /* Initially hidden */
      margin-top: 20px;
      padding: 20px;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      color: black;
    }
    #selected-wo-details-section h2 {
      text-align: center;
      margin-top: 0;
      color: black;
    }
    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 20px;
      margin-bottom: 20px;
    }
    .details-grid p {
      margin: 0;
      color: black;
    }
    .details-grid strong {
      color: black;
    }
    .gantt-all-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin-top: 20px;
    }
    .single-gantt-card {
        background: white;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        color: black;
    }
    .single-gantt-card canvas {
        width: 100% !important;
        height: 150px !important;
    }
    .search-bar-container {
      margin-bottom: 15px;
      text-align: center;
    }
    #activities-table-popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      justify-content: center;
      align-items: center;
    }
    #activities-table-popup-content {
      background-color: white;
      padding: 20px;
      border-radius: 5px;
      width: 90%;
      max-width: 800px;
      max-height: 90%;
      position: relative;
      overflow-y: auto;
      color: black;
    }
    #activities-table-popup-content .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      cursor: pointer;
      color: black;
    }
    #activities-table-popup-content button {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #6a5acd;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #image-preview-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 10002;
        justify-content: center;
        align-items: center;
    }
    #image-preview-content {
        position: relative;
        max-width: 90vw;
        max-height: 90vh;
    }
    #image-preview-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }
    #image-preview-content .close-btn {
        position: absolute;
        top: -15px;
        right: -15px;
        font-size: 30px;
        font-weight: bold;
        cursor: pointer;
        color: white;
        background: rgba(0,0,0,0.5);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        line-height: 30px;
        text-align: center;
    }
  </style>
</head>
<body>

<div id="password-overlay">
  <div id="password-overlay-content">
      <h1>UNIVERSITY OF CAGAYAN VALLEY</h1>
      <input type="password" id="system-password" placeholder="Enter Password">
      <button id="enter-button">Enter</button>
  </div>
</div>

<div id="print-template">
    <div class="print-background"></div>
    <div class="print-page">
      <div class="print-label">OPPM copy - File</div>
      <div class="header" style="overflow: hidden; margin-bottom: 5px;">
         <img src="images/UCVV.png" alt="logo" width="780" style="float: center;">
               <div style="text-align: center;">
                   <hr style="border: none; height: 2px; background-color: black; margin: 3px 0;">
        </div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Requesting Party:</label><span id="print-req-party-1"></span></div>
          <div class="form-group"><label>Position:</label><span id="print-req-position-1"></span></div>
          <div class="form-group"><label>W.O. Request No.:</label><span id="print-wo-number-1"></span></div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Building:</label><span id="print-building-1"></span></div>
          <div class="form-group"><label>Date Requested:</label><span id="print-date-requested-1"></span></div>
          <div class="form-group"><label>Date Started:</label><span id="print-date-started-1"></span></div>
      </div>
      <div class="form-group"><label>Estimate Date Accomplished:</label><span id="print-estimate-date-accomplished-1"></span></div>
      <div class="form-group"><label>Description:</label><span id="print-description-1"></span></div>
      <h4 style="margin-top: 5px; margin-bottom: 5px;">TO BE FILLED BY OPPM/OPLS STAFF</h4>
      <table style="font-size: 8pt;">
        <thead>
          <tr>
            <th>Room/Office</th>
            <th>QTY</th>
            <th>PARTICULARS</th>
            <th>AVAILABLE</th>
            <th>NOT AVAILABLE</th>
          </tr>
        </thead>
        <tbody id="print-materials-body-1"></tbody>
      </table>
      <div class="form-group"><label>Status:</label><span id="print-status-1"></span></div>
      <div class="form-group"><label>Remarks:</label><span id="print-remarks-1"></span></div>
      <div class="signatories" style="margin-top: 15px;">
        <div class="signature-box" style="width: 48%;">
           <div style="text-align: left; font-size: 9pt;"><strong>Performed by:</strong></div><br>
        <div style="text-align: center; font-size: 9pt;">
          <span id="print-performed-by-1" style="display: block; border-bottom: 1px solid #000; padding-bottom: 2px;"></span>
          <div class="signature-line"></div>
          OPPM Technician
          </div>
        </div>
        <div class="signature-box" style="width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Requesting Party:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <strong><span id="print-printedRequestorName-1"></span></strong>
            <div class="signature-line"></div>
            <span id="print-printedRequestorPosition-1"></span>
          </div>
        </div>
      </div>
      <div class="signatories" style="margin-top: 10px;">
        <div class="signature-box" style="margin: auto; width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Concurred by:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <div class="signature-img-container">
                <img id="print-signature-1" src="signature.jpg" alt="Signature">
            </div>
            <strong id="print-concurred-by-name-1"></strong><br>
            <div class="signature-line"></div>
            <span id="print-concurred-by-title-1"></span>
          </div>
        </div>
      </div>
      <div id="print-evidence-1">
        </div>
    </div>
    <div class="dotted-line-separator"></div>
    <div class="print-page">
      <div class="print-label">Requestor's copy</div>
      <div class="header" style="overflow: hidden; margin-bottom: 5px;">
         <img src="images/UCVV.png" alt="logo" width="780" style="float: left;">
                <div style="text-align: center;">
                    <hr style="border: none; height: 2px; background-color: black; margin: 3px 0;">
        </div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Requesting Party:</label><span id="print-req-party-2"></span></div>
          <div class="form-group"><label>Position:</label><span id="print-req-position-2"></span></div>
          <div class="form-group"><label>W.O. Request No.:</label><span id="print-wo-number-2"></span></div>
      </div>
      <div class="form-row">
          <div class="form-group"><label>Building:</label><span id="print-building-2"></span></div>
          <div class="form-group"><label>Date Requested:</label><span id="print-date-requested-2"></span></div>
          <div class="form-group"><label>Date Started:</label><span id="print-date-started-2"></span></div>
      </div>
      <div class="form-group"><label>Estimate Date Accomplished:</label><span id="print-estimate-date-accomplished-2"></span></div>
      <div class="form-group"><label>Description:</label><span id="print-description-2"></span></div>
      <h4 style="margin-top: 5px; margin-bottom: 5px;">TO BE FILLED BY OPPM/OPLS STAFF</h4>
      <table style="font-size: 8pt;">
        <thead>
          <tr>
            <th>Room/Office</th>
            <th>QTY</th>
            <th>PARTICULARS</th>
            <th>AVAILABLE</th>
            <th>NOT AVAILABLE</th>
          </tr>
        </thead>
        <tbody id="print-materials-body-2"></tbody>
      </table>
      <div class="form-group"><label>Status:</label><span id="print-status-2"></span></div>
      <div class="form-group"><label>Remarks:</label><span id="print-remarks-2"></span></div>
      <div class="signatories" style="margin-top: 15px;">
        <div class="signature-box" style="width: 48%;">
           <div style="text-align: left; font-size: 9pt;"><strong>Performed by:</strong></div><br>
        <div style="text-align: center; font-size: 9pt;">
          <span id="print-performed-by-2" style="display: block; border-bottom: 1px solid #000; padding-bottom: 2px;"></span>
          <div class="signature-line"></div>
          OPPM Technician
          </div>
        </div>
        <div class="signature-box" style="width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Requesting Party:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <strong><span id="print-printedRequestorName-2"></span></strong>
            <div class="signature-line"></div>
            <span id="print-printedRequestorPosition-2"></span>
          </div>
        </div>
      </div>
      <div class="signatories" style="margin-top: 10px;">
        <div class="signature-box" style="margin: auto; width: 48%;">
          <div style="text-align: left; font-size: 9pt;"><strong>Concurred by:</strong></div><br>
          <div style="text-align: center; font-size: 9pt;">
            <div class="signature-img-container">
                <img id="print-signature-2" src="signature.jpg" alt="Signature">
            </div>
            <strong id="print-concurred-by-name-2"></strong><br>
            <div class="signature-line"></div>
            <span id="print-concurred-by-title-2"></span>
          </div>
        </div>
      </div>
      <div id="print-evidence-2">
        </div>
    </div>
    <div class="dotted-line-separator"></div>
</div>

<div id="dashboard" class="hidden-by-password">
    <div class="dashboard-header">
        <img src="images/UCV.png" alt="logo" width="100" style="float: left;">
        <img src="images/oppm logo.png" alt="logo" width="100" style="float: right;">
        <h2>UNIVERSITY OF CAGAYAN VALLEY</h2>
        <p>OFFICE OF THE PHYSICAL PLANT AND MAINTENANCE</p>
        <p>WORK ORDER DASHBOARD</p>
    </div>

    <div class="stats-container">
        <div class="stat-box" onclick="viewAllGanttCharts()">
            <h3>View All Gantt Charts</h3>
            <p>📊</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('Pending')">
            <h3>Pending</h3>
            <p id="pending-count">0</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('In Progress')">
            <h3>In Progress</h3>
            <p id="inprogress-count">0</p>
        </div>
        <div class="stat-box" onclick="openWorkOrderList('Completed')">
            <h3>Completed</h3>
            <p id="completed-count">0</p>
        </div>
    </div>

    <div class="dashboard-actions">
        <button onclick="clearAllFields(); openNewOrderPopup();">📝 New Order Request</button>
        <button onclick="openWorkOrderList('All')">📂 View All Saved Orders</button>
        <button onclick="printSummary()">🖨️ Print Summary</button>
    </div>

    <div id="dashboard-container">
        <div id="work-order-list-container" class="dashboard-section">
            <h2 style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                Work Order List
                <button onclick="openAboutPopup()" title="About the Author" style="font-family: 'Times New Roman', serif; font-weight: bold; font-style: italic; width: 24px; height: 24px; border-radius: 50%; padding: 0; font-size: 14px; line-height: 24px; vertical-align: middle; margin: 0; background-color: #6a5acd; color: white; border: none; cursor: pointer;">i</button>
            </h2>
            <div class="search-bar-container">
              <input type="search" id="wo-search" oninput="searchWorkOrders()" placeholder="Search by WO number..." style="width: 90%;">
            </div>
            <div id="wo-list" class="wo-list-container">
            </div>
        </div>
        <div id="details-and-gantt-container">
            <div id="selected-wo-details-section">
                <h2 id="details-section-title">Work Order Details & Gantt Chart</h2>
                <div class="details-grid">
                    <p><strong>Work Order #:</strong> <span id="detail-wo-number"></span></p>
                    <p><strong>Requesting Party:</strong> <span id="detail-req-party"></span></p>
                    <p><strong>Building:</strong> <span id="detail-building"></span></p>
                    <p><strong>Position:</strong> <span id="detail-req-position"></span></p>
                    <p><strong>Date Requested:</strong> <span id="detail-date-requested"></span></p>
                    <p><strong>Date Started:</strong> <span id="detail-date-started"></span></p>
                    <p><strong>Estimated Date of Accomplishment:</strong> <span id="detail-date-accomplished"></span></p>
                    <p><strong>Status:</strong> <span id="detail-status"></span></p>
                    <p><strong>Total Cost:</strong> <span id="detail-total-cost"></span></p>
                </div>
                <div class="details-actions">
                    <button id="edit-button">📝 Edit</button>
                    <button id="print-button">🖨️ Print</button>
                    <button id="delete-button">🗑️ Delete</button>
                    <button id="view-activities-button">📄 View Activities</button>
                    <button id="edit-activities-button">✏️ Edit Activities</button>
                    <button id="costing-button" onclick="openCostingPopup()">💰 Costing</button>
                    <button id="master-print-button" onclick="showMasterPrintPreview()">Master Print</button>
                </div>
                <div class="wo-gantt-section">
                    <h4>Gantt Chart Preview</h4>
                    <canvas id="wo-gantt-canvas"></canvas>
                </div>
                <div id="evidence-section" class="dashboard-section" style="margin-top: 20px;">
                    <h4>Evidence</h4>
                    <div id="evidence-preview-details" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; padding: 10px; border: 1px solid #eee; min-height: 120px; border-radius: 8px;">
                        </div>
                    <input type="file" id="evidence-upload-details" multiple accept="image/*" style="display: block; margin-bottom: 10px;">
                    <button id="add-evidence-button">Add Selected Images</button>
                </div>
            </div>
            <div id="all-gantt-charts-section" style="display: none;" class="dashboard-section">
                <h2>All Work Order Timelines</h2>
                <div id="all-gantt-container" class="gantt-all-container">
                </div>
            </div>
        </div>
    </div>
</div>

<div id="new-order-popup" class="popup-overlay">
    <div class="popup-content">
        <span class="minimize-btn" onclick="closeNewOrderPopup()">—</span>
        <span class="close-btn" onclick="closeNewOrderPopup()">×</span>
        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="btn-print">
                    <button onclick="printCurrentForm()">🖨️ Print</button>
                    <button onclick="clearAllFields()">🧹 Clear Data</button>
                    <button onclick="saveWorkOrder()">💾 Save</button>
                </div>
                <div style="font-size: 11pt;">
                    <strong>Last WO Entered:</strong>
                    <span id="last-wo-in-popup" style="color: #6a5acd; font-weight: bold;">N/A</span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group"><label>Requesting Party:</label><input type="text" id="req-party" oninput="syncRequestor()"></div>
                <div class="form-group"><label>Position:</label><input type="text" id="req-position" oninput="syncRequestor()"></div>
                <div class="form-group"><label>W.O. Request No.:</label><input type="text" id="wo-number"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Building:</label><input type="text" id="building"></div>
                <div class="form-group"><label>Date Requested:</label><input type="date" id="date-requested"></div>
                <div class="form-group"><label>Date Started:</label><input type="date" id="date-started"></div>
            </div>
            <div class="form-group"><label>Estimate Date Accomplished:</label><input type="date" id="estimate-date-accomplished"></div>
            <div class="form-group"><label>Description:</label><textarea id="description"></textarea></div>

            <div style="text-align: center; margin: 20px 0;">
                <button onclick="showTablePopup()">Fill Material Details 📋</button>
            </div>

            <div class="form-group">
                <label>Status:</label>
                <select id="status">
                    <option value="Pending">Pending</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Completed">Completed</option>
                </select>
            </div>
            <div class="form-group"><label>Remarks:</label><textarea id="remarks"></textarea></div>

            <div class="signatories">
                <div class="signature-box">
                    <div style="text-align: left;"><strong>Performed by:</strong></div>
                    <div style="text-align: center;">
                        <input type="text" id="performed-by" placeholder="Enter technician name" style="width: 90%; text-align: center; border-bottom: 1px solid #000;">
                        <div class="signature-line"></div>
                        OPPM Technician
                    </div>
                </div>
                <div class="signature-box">
                    <div style="text-align: left;"><strong>Requesting Party:</strong></div>
                    <div style="text-align: center;">
                        <strong><span id="printedRequestorName">________________________</span></strong>
                        <div class="signature-line"></div>
                        <span id="printedRequestorPosition">________________________</span>
                    </div>
                </div>
            </div>
            <div class="signatories">
                <div class="signature-box" style="margin: auto;">
                    <div style="text-align: left;"><strong>Concurred by:</strong></div>
                    <div style="text-align: center;">
                        <select id="concurred-by-select" onchange="updateConcurredBy()">
                            <option value="ENGR. BENEDICT L. LOSTE, RCE" data-title="OPPM Director">ENGR. BENEDICT L. LOSTE, RCE</option>
                            <option value="ENGR. GLENN D. LUNA, REE, MBA" data-title="Supervisor, Electrical Unit">ENGR. GLENN D. LUNA, REE, MBA</option>
                        </select>
                        <br>
                        <div class="signature-line"></div>
                        <span id="concurred-by-title">OPPM Director</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="about-popup" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeAboutPopup()">×</span>
        <img src="images/grad pic.jpg" alt="Author's Picture" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; margin: 0 auto 20px auto; display: block;">
        <h3 style="margin-bottom: 20px;">About the Author</h3>
        <p style="text-align: left; line-height: 1.6; font-size: 12pt;">
            This system was created and developed by <strong>Engr. Glenn Dela Cruz Luna, REE, RME, MBA</strong>, a licensed professional with a Bachelor of Science in Electrical Engineering from Cagayan State University and a Master’s degree in Business Administration from the University of Cagayan Valley.
            <br><br>
            He currently holds the position of Electrical Engineer and Electrical Supervisor at the University of Cagayan Valley, where he leads key initiatives in infrastructure and technical operations.
        </p>
    </div>
</div>

<div id="image-preview-overlay" onclick="closeImagePreview()">
    <div id="image-preview-content">
        <span class="close-btn" onclick="closeImagePreview()">×</span>
        <img id="preview-img" src="" alt="Image Preview">
    </div>
</div>

<div id="duplicate-alert">
    <div style="font-size: 40px; margin-bottom: 10px;">🚨</div>
    <div class="alert-content"><strong>Duplicate WO Number!</strong></div>
    <div>This WO number already exists.</div>
    <button onclick="hideDuplicateAlert()">OK</button>
</div>

<audio id="alert-sound" src="data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU5LjI3LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAASW5mbwAAAA8" preload="auto"></audio>

<div id="table-popup-overlay">
    <div id="table-popup-content">
        <span class="close-btn" onclick="closeTablePopup()">×</span>
        <h3 style="text-align: center;">Material & Staff Details 📋</h3>
        <table id="materials-table">
            <thead>
                <tr>
                    <th>Room/Office</th>
                    <th>QTY</th>
                    <th>PARTICULARS</th>
                    <th>AVAILABLE</th>
                    <th>NOT AVAILABLE</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="materials-body"></tbody>
        </table>
        <button id="add-material-btn" onclick="addMaterialRow()">➕ Add Row</button>
    </div>
</div>

<div id="activities-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeActivitiesPopup()">×</span>
        <h3>Work Order Activities</h3>
        <div id="activities-list" style="overflow-y: auto;">
        </div>
    </div>
</div>

<div id="activities-table-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeActivitiesTablePopup()">×</span>
        <h3 style="text-align: center;">Edit Activities 📝</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">Editing activities for Work Order: <span id="activities-wo-number-display"></span></p>
        <table id="activities-table">
            <thead>
                <tr>
                    <th>Activity</th>
                    <th>Date Start</th>
                    <th>Date End</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="activities-body"></tbody>
        </table>
        <button id="add-activity-btn" onclick="addActivityRow()">➕ Add Row</button>
        <div style="text-align: center;">
            <button onclick="saveActivities()">Save Activities</button>
        </div>
    </div>
</div>

<div id="costing-popup-overlay" class="popup-overlay">
    <div class="popup-content">
        <span class="close-btn" onclick="closeCostingPopup()">×</span>
        <h3 style="text-align: center;">Project Costing 💰</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">Costing for Work Order: <span id="costing-wo-number-display"></span></p>
        <table id="costing-table">
            <thead>
                <tr>
                    <th>Particulars</th>
                    <th>Quantity</th>
                    <th>Unit</th>
                    <th>Unit Cost</th>
                    <th>Total</th>
                    <th class="delete-column">🗑️</th>
                </tr>
            </thead>
            <tbody id="costing-body"></tbody>
        </table>
        <div style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 12pt;">
            Grand Total: <span id="grand-total">₱0.00</span>
        </div>
        <button id="add-costing-row-btn" onclick="addCostingRow()">➕ Add Row</button>
        <div style="text-align: center;">
            <button onclick="saveCosting()">Save Costing</button>
        </div>
    </div>
</div>

<div id="master-print-preview-popup" class="popup-overlay">
    <div class="popup-content" style="max-width: 8.5in;">
        <span class="close-btn" onclick="closeMasterPrintPreview()">×</span>
        <h3 style="text-align: center;">Master Print Preview</h3>
        <div id="master-print-preview-content" style="height: 70vh; overflow-y: auto; border: 1px solid #ccc; padding: 15px; background: white;">
            </div>
        <div style="text-align: center; margin-top: 15px;">
            <button onclick="executeMasterPrint()">🖨️ Print</button>
        </div>
    </div>
</div>

<div id="status-remarks-popup-overlay" class="popup-overlay">
    <div class="popup-content" style="max-width: 500px;">
        <span class="close-btn" onclick="closeStatusRemarksPopup()">×</span>
        <h3 style="text-align: center;">Update Status & Remarks</h3>
        <p style="text-align: center; font-size: 10pt; color: #666;">For Work Order: <span id="status-remarks-wo-number-display"></span></p>
        <div class="form-group">
            <label>Status:</label>
            <select id="popup-status-select">
                <option value="Pending">Pending</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
        <div class="form-group">
            <label>Remarks:</label>
            <textarea id="popup-remarks-textarea" style="height: 100px;"></textarea>
        </div>
        <div style="text-align: center;">
            <button onclick="saveStatusRemarks()">Save Changes</button>
        </div>
    </div>
</div>


<div id="print-summary-container">
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
  // Global state
  let editingWoNumber = null;
  let currentFilter = 'All';
  let ganttChart = null;
  let allGanttCharts = [];
  let woNumberForStatusUpdate = null;
  let allWorkOrders = []; // Central cache for all orders

  const API_URL = '/api/work-orders';
  const colors = [
    '#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6',
    '#e67e22', '#1abc9c', '#f39c12', '#d35400', '#c0392b',
    '#2980b9', '#8e44ad', '#34495e', '#7f8c8d', '#27ae60'
  ];

  // Utility functions
  function formatCurrency(number) {
    return new Intl.NumberFormat('en-PH', {
        style: 'currency',
        currency: 'PHP'
    }).format(number);
  }

  function syncRequestor() {
    document.getElementById('printedRequestorName').textContent = document.getElementById('req-party').value || "________________________";
    document.getElementById('printedRequestorPosition').textContent = document.getElementById('req-position').value || "________________________";
  }

  // Password and Initialization
  window.addEventListener('DOMContentLoaded', () => {
      // The password overlay now just hides the dashboard, no localStorage flag needed.
      const passwordInput = document.getElementById("system-password");
      const enterButton = document.getElementById("enter-button");

      function tryLogin() {
          const input = passwordInput.value;
          // Simple password check. In a real app, this should be done on the server.
          if (input === "admin123") {
              document.getElementById("password-overlay").style.display = "none";
              document.getElementById("dashboard").classList.remove('hidden-by-password');
              document.getElementById("dashboard").style.display = 'block';
              initializeDashboard();
          } else {
              alert("Incorrect password");
          }
      }

      enterButton.addEventListener("click", tryLogin);
      passwordInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") tryLogin();
      });

      // Automatically focus password field
      passwordInput.focus();
      addMaterialRow();
  });

  async function initializeDashboard() {
      await fetchAllWorkOrders();
      populateWorkOrderList('All');
      updateDashboardStats();
      updateLastWoNumberDisplays();
  }

  async function fetchAllWorkOrders() {
      try {
          const response = await fetch(API_URL);
          if (!response.ok) throw new Error('Failed to fetch work orders');
          allWorkOrders = await response.json();
      } catch (error) {
          console.error("Fetch Error:", error);
          alert("Could not load work orders from the server.");
          allWorkOrders = [];
      }
  }

  // Dashboard UI updates
  function updateDashboardStats() {
      let pending = 0, inProgress = 0, completed = 0;
      allWorkOrders.forEach(order => {
          if (order.status === 'Pending') pending++;
          else if (order.status === 'In Progress') inProgress++;
          else if (order.status === 'Completed') completed++;
      });

      document.getElementById('pending-count').textContent = pending;
      document.getElementById('inprogress-count').textContent = inProgress;
      document.getElementById('completed-count').textContent = completed;
  }

  function updateLastWoNumberDisplays() {
      const lastWoSpanPopup = document.getElementById('last-wo-in-popup');
      if (allWorkOrders.length === 0) {
          lastWoSpanPopup.textContent = 'N/A';
          return;
      }

      let lastWoNumber = '';
      let maxNumericPart = -1;

      allWorkOrders.forEach(order => {
          const numericPart = parseInt(order.woNumber.replace(/\D/g, ''), 10);
          if (!isNaN(numericPart) && numericPart > maxNumericPart) {
              maxNumericPart = numericPart;
              lastWoNumber = order.woNumber;
          }
      });
      lastWoSpanPopup.textContent = lastWoNumber || 'N/A';
  }

  // Data Manipulation (CRUD)
  async function saveWorkOrder() {
      const woNumber = document.getElementById('wo-number').value.trim();
      if (!woNumber) return alert("WO Number is required.");

      const order = {
          woNumber,
          reqParty: document.getElementById('req-party').value,
          reqPosition: document.getElementById('req-position').value,
          building: document.getElementById('building').value,
          dateRequested: document.getElementById('date-requested').value,
          dateStarted: document.getElementById('date-started').value,
          estimateDateAccomplished: document.getElementById('estimate-date-accomplished').value,
          description: document.getElementById('description').value,
          status: document.getElementById('status').value,
          remarks: document.getElementById('remarks').value,
          technician: document.getElementById('performed-by').value,
          materials: getMaterialRows(),
          concurredBy: document.getElementById('concurred-by-select').value,
          concurredByTitle: document.getElementById('concurred-by-title').textContent,
          // Get existing data if editing, otherwise initialize as empty
          evidence: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.evidence || []) : [],
          activities: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.activities || []) : [],
          costing: editingWoNumber ? (allWorkOrders.find(o => o.woNumber === editingWoNumber)?.costing || []) : [],
          savedAt: new Date().toLocaleString()
      };

      try {
          let response;
          if (editingWoNumber) {
              // Update existing order
              response = await fetch(`${API_URL}/${editingWoNumber}`, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(order)
              });
          } else {
              // Create new order
              response = await fetch(API_URL, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(order)
              });
          }

          if (response.status === 409) {
              return showDuplicateAlert();
          }
          if (!response.ok) {
              const err = await response.json();
              throw new Error(err.message || 'Server error');
          }

          alert("Work Order saved successfully!");
          closeNewOrderPopup();
          await initializeDashboard(); // Refresh all data from server

      } catch (error) {
          console.error("Save Error:", error);
          alert(`Error saving work order: ${error.message}`);
      }
  }

  async function deleteWorkOrder(woNumber) {
    const pass = prompt("Enter password to delete:");
    if (pass !== 'admin123') return alert("Incorrect password");

    if (!confirm(`Are you sure you want to delete Work Order #${woNumber}?`)) return;

    try {
        const response = await fetch(`${API_URL}/${woNumber}`, { method: 'DELETE' });
        if (!response.ok && response.status !== 204) {
            throw new Error('Failed to delete on server.');
        }

        alert("Deleted successfully.");
        document.getElementById('selected-wo-details-section').style.display = 'none';
        await initializeDashboard(); // Refresh data

    } catch (error) {
        console.error("Delete Error:", error);
        alert("Error deleting work order.");
    }
}

  // Populating Lists and Details
  function populateWorkOrderList(filterStatus, ordersToDisplay = null) {
      currentFilter = filterStatus;
      let orders = ordersToDisplay;
      if (!orders) {
          orders = allWorkOrders.filter(entry => filterStatus === 'All' || entry.status === filterStatus);
      }

      orders.sort((a, b) => {
          const numA = parseInt(a.woNumber.replace(/\D/g, ''), 10) || 0;
          const numB = parseInt(b.woNumber.replace(/\D/g, ''), 10) || 0;
          return numA - numB;
      });

      const container = document.getElementById('wo-list');
      container.innerHTML = '';

      if (orders.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: #888;">No work orders found.</p>';
          return;
      }

      orders.forEach(entry => {
          const div = document.createElement('div');
          div.className = 'wo-btn';
          div.style.display = 'flex';
          div.style.justifyContent = 'space-between';
          div.style.alignItems = 'center';
          div.innerHTML = `
            <div onclick="displayWorkOrderDetails('${entry.woNumber}')" style="cursor: pointer; flex-grow: 1;">
                <strong>WO#:</strong> ${entry.woNumber} | <strong>Status:</strong> ${entry.status}<br>
                <strong>Party:</strong> ${entry.reqParty}<br>
                <strong>Date:</strong> ${entry.dateRequested}
            </div>
            <button onclick="openStatusRemarksPopup('${entry.woNumber}', event)" style="margin-left: 10px; padding: 5px 10px; font-size: 10pt;">Edit Status</button>
          `;
          container.appendChild(div);
      });
  }

    function loadWorkOrder(woNumber) {
      const pass = prompt("Enter password to edit:");
      if (pass !== 'admin123') return alert("Incorrect password");
      const order = allWorkOrders.find(o => o.woNumber === woNumber);
      if (!order) return alert('Work order not found.');

      clearAllFields();
      editingWoNumber = woNumber;

      document.getElementById('wo-number').value = order.woNumber;
      document.getElementById('req-party').value = order.reqParty;
      document.getElementById('req-position').value = order.reqPosition;
      document.getElementById('building').value = order.building;
      document.getElementById('date-requested').value = order.dateRequested;
      document.getElementById('date-started').value = order.dateStarted;
      document.getElementById('estimate-date-accomplished').value = order.estimateDateAccomplished || '';
      document.getElementById('description').value = order.description;
      document.getElementById('status').value = order.status;
      document.getElementById('remarks').value = order.remarks;
      document.getElementById('performed-by').value = order.technician || '';
      setMaterialRows(order.materials);
      setActivities(order.activities);
      syncRequestor();
      document.getElementById('concurred-by-select').value = order.concurredBy;
      updateConcurredBy();

      openNewOrderPopup();
  }

  function displayWorkOrderDetails(woNumber) {
    const order = allWorkOrders.find(o => o.woNumber === woNumber);

    if (!order) {
        alert('Work order not found.');
        return;
    }

    editingWoNumber = woNumber;

    document.getElementById('all-gantt-charts-section').style.display = 'none';
    const detailsSection = document.getElementById('selected-wo-details-section');
    detailsSection.style.display = 'block';

    document.getElementById('detail-wo-number').textContent = order.woNumber;
    document.getElementById('detail-req-party').textContent = order.reqParty;
    document.getElementById('detail-req-position').textContent = order.reqPosition;
    document.getElementById('detail-building').textContent = order.building;
    document.getElementById('detail-date-requested').textContent = order.dateRequested;
    document.getElementById('detail-date-started').textContent = order.dateStarted;
    document.getElementById('detail-date-accomplished').textContent = order.estimateDateAccomplished || 'N/A';
    document.getElementById('detail-status').textContent = order.status;

    let totalCost = 0;
    if (order.costing && Array.isArray(order.costing)) {
        order.costing.forEach(item => {
            totalCost += parseFloat(item.total) || 0;
        });
    }
    document.getElementById('detail-total-cost').textContent = formatCurrency(totalCost);

    document.getElementById('edit-button').onclick = () => loadWorkOrder(woNumber);
    document.getElementById('print-button').onclick = () => printSpecificWorkOrder(woNumber);
    document.getElementById('delete-button').onclick = () => deleteWorkOrder(woNumber);
    document.getElementById('view-activities-button').onclick = () => showActivitiesPopup(order.activities);
    document.getElementById('edit-activities-button').onclick = () => showActivitiesTablePopup(order.activities);
    document.getElementById('costing-button').onclick = () => openCostingPopup(woNumber);

    // Render Evidence
    renderEvidence(woNumber, order.evidence || []);

    renderGanttChart(order);
  }

    // Evidence Handling
    function renderEvidence(woNumber, evidenceArray) {
        const evidencePreviewContainer = document.getElementById('evidence-preview-details');
        evidencePreviewContainer.innerHTML = ''; // Clear previous images

        if (Array.isArray(evidenceArray) && evidenceArray.length > 0) {
            evidenceArray.forEach((imgData, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.style.position = 'relative';
                imgWrapper.style.margin = '5px';

                const img = document.createElement('img');
                img.src = imgData;
                img.style.width = '100px';
                img.style.height = '100px';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '5px';
                img.style.cursor = 'pointer';
                img.onclick = () => openImagePreview(imgData);

                const deleteBtn = document.createElement('span');
                deleteBtn.innerHTML = '×';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-5px';
                deleteBtn.style.right = '-5px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.background = 'rgba(255,0,0,0.8)';
                deleteBtn.style.color = 'white';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.textAlign = 'center';
                deleteBtn.style.lineHeight = '20px';
                deleteBtn.style.fontWeight = 'bold';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteEvidence(woNumber, index);
                };

                imgWrapper.appendChild(img);
                imgWrapper.appendChild(deleteBtn);
                evidencePreviewContainer.appendChild(imgWrapper);
            });
        }
        document.getElementById('add-evidence-button').onclick = () => addEvidence(woNumber);
    }

    async function addEvidence(woNumber) {
        const files = document.getElementById('evidence-upload-details').files;
        if (files.length === 0) return alert('Please select one or more images to upload.');

        let order = allWorkOrders.find(o => o.woNumber === woNumber);
        if (!order) return alert('Error: Work order not found.');

        const filePromises = Array.from(files).map(file => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsDataURL(file);
            });
        });

        try {
            const base64Images = await Promise.all(filePromises);
            if (!Array.isArray(order.evidence)) {
                order.evidence = [];
            }
            order.evidence.push(...base64Images);

            // Save the updated order back to the server
            const response = await fetch(`${API_URL}/${woNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to save evidence to server.');

            alert(`${base64Images.length} image(s) added successfully!`);
            document.getElementById('evidence-upload-details').value = '';
            await fetchAllWorkOrders(); // Re-fetch to get the latest state
            displayWorkOrderDetails(woNumber); // Refresh view

        } catch (error) {
            console.error("Error adding evidence: ", error);
            alert("There was an error uploading the images.");
        }
    }

    async function deleteEvidence(woNumber, index) {
        if (!confirm('Are you sure you want to delete this image?')) return;

        let order = allWorkOrders.find(o => o.woNumber === woNumber);
        if (!order || !order.evidence || !order.evidence[index]) return;

        order.evidence.splice(index, 1); // Remove the image

        try {
            // Save the updated order back to the server
            const response = await fetch(`${API_URL}/${woNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to update evidence on server.');

            await fetchAllWorkOrders(); // Re-fetch to get the latest state
            displayWorkOrderDetails(woNumber); // Refresh view

        } catch (error) {
            console.error("Error deleting evidence:", error);
            alert("Failed to delete evidence.");
        }
    }

  // Other UI functions (Popups, printing, etc.) - Most of these can remain the same
  function openWorkOrderList(filterStatus = 'All') {
    document.getElementById('selected-wo-details-section').style.display = 'none';
    document.getElementById('all-gantt-charts-section').style.display = 'none';
    populateWorkOrderList(filterStatus);
  }

  function searchWorkOrders() {
      const searchTerm = document.getElementById('wo-search').value.toLowerCase();
      const filteredOrders = allWorkOrders.filter(order => order.woNumber.toLowerCase().includes(searchTerm));
      populateWorkOrderList(null, filteredOrders);
  }

  function openImagePreview(src) {
    document.getElementById('preview-img').src = src;
    document.getElementById('image-preview-overlay').style.display = 'flex';
  }

  function closeImagePreview() {
    document.getElementById('image-preview-overlay').style.display = 'none';
  }

  function showDuplicateAlert() {
    document.getElementById('duplicate-alert').style.display = 'flex';
    document.getElementById('alert-sound').play();
    setTimeout(() => hideDuplicateAlert(), 5000);
  }

  function hideDuplicateAlert() {
    document.getElementById('duplicate-alert').style.display = 'none';
  }

  function clearAllFields() {
    const ids = ['wo-number', 'req-party', 'req-position', 'building', 'date-requested', 'date-started', 'estimate-date-accomplished'];
    ids.forEach(id => document.getElementById(id).value = '');
    document.getElementById('description').value = '';
    document.getElementById('remarks').value = '';
    document.getElementById('performed-by').value = '';
    document.getElementById('materials-body').innerHTML = '';
    addMaterialRow();
    document.getElementById('activities-body').innerHTML = '';
    addActivityRow();
    syncRequestor();
    editingWoNumber = null;
    document.getElementById('concurred-by-select').value = "ENGR. GLENN D. LUNA, REE, MBA";
    updateConcurredBy();
    document.getElementById('status').value = "Pending";
  }

    // The rest of your UI and helper functions (addMaterialRow, printCurrentForm, renderGanttChart, etc.)
    // do not need significant changes as they mostly deal with the DOM.
    // I am including them here for completeness.

  function addMaterialRow() {
    const tbody = document.getElementById('materials-body');
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><input type="text" class="room"></td>
      <td><input type="text" class="qty"></td>
      <td><input type="text" class="particular"></td>
      <td><input type="checkbox" class="avail"></td>
      <td><input type="checkbox" class="notavail"></td>
      <td class="delete-column"><button onclick="deleteMaterialRow(this)">🗑️</button></td>
    `;
    tbody.appendChild(row);
  }

  function getMaterialRows() {
    return Array.from(document.querySelectorAll('#materials-body tr')).map(row => ({
      room: row.querySelector('.room')?.value || '',
      qty: row.querySelector('.qty')?.value || '',
      particular: row.querySelector('.particular')?.value || '',
      avail: row.querySelector('.avail')?.checked || false,
      notavail: row.querySelector('.notavail')?.checked || false
    }));
  }

  function setMaterialRows(materials) {
    const tbody = document.getElementById('materials-body');
    tbody.innerHTML = '';
    if (materials && materials.length > 0) {
      materials.forEach(() => addMaterialRow());
      const rows = document.querySelectorAll('#materials-body tr');
      materials.forEach((item, i) => {
        if (rows[i]) {
          rows[i].querySelector('.qty').value = item.qty;
          rows[i].querySelector('.room').value = item.room;
          rows[i].querySelector('.particular').value = item.particular;
          rows[i].querySelector('.avail').checked = item.avail;
          rows[i].querySelector('.notavail').checked = item.notavail;
        }
      });
    } else {
        addMaterialRow();
    }
  }

  function deleteMaterialRow(button) {
    const row = button.closest('tr');
    row.remove();
  }

  function updateConcurredBy() {
      const select = document.getElementById('concurred-by-select');
      const selectedOption = select.options[select.selectedIndex];
      const titleSpan = document.getElementById('concurred-by-title');
      titleSpan.textContent = selectedOption.dataset.title;
  }

  function populatePrintTemplate(order, suffix) {
      document.getElementById('print-wo-number' + suffix).textContent = order.woNumber;
      document.getElementById('print-req-party' + suffix).textContent = order.reqParty;
      document.getElementById('print-req-position' + suffix).textContent = order.reqPosition;
      document.getElementById('print-building' + suffix).textContent = order.building;
      document.getElementById('print-date-requested' + suffix).textContent = order.dateRequested;
      document.getElementById('print-date-started' + suffix).textContent = order.dateStarted;
      document.getElementById('print-estimate-date-accomplished' + suffix).textContent = order.estimateDateAccomplished || '';
      document.getElementById('print-description' + suffix).textContent = order.description;
      document.getElementById('print-status' + suffix).textContent = order.status;
      document.getElementById('print-remarks' + suffix).textContent = order.remarks;
      document.getElementById('print-performed-by' + suffix).textContent = order.technician || '________________________';
      document.getElementById('print-printedRequestorName' + suffix).textContent = order.reqParty || '________________________';
      document.getElementById('print-printedRequestorPosition' + suffix).textContent = order.reqPosition || '________________________';
      document.getElementById('print-concurred-by-name' + suffix).textContent = order.concurredBy;
      document.getElementById('print-concurred-by-title' + suffix).textContent = order.concurredByTitle;
      const printMaterialsBody = document.getElementById('print-materials-body' + suffix);
      printMaterialsBody.innerHTML = '';
      if (order.materials) {
          order.materials.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${item.room}</td><td>${item.qty}</td><td>${item.particular}</td><td>${item.avail ? '✔️' : ''}</td><td>${item.notavail ? '❌' : ''}</td>`;
            printMaterialsBody.appendChild(row);
          });
      }
      const printEvidenceDiv = document.getElementById('print-evidence' + suffix);
      const firstEvidence = Array.isArray(order.evidence) ? order.evidence[0] : order.evidence;
      if (firstEvidence) {
          printEvidenceDiv.innerHTML = `<img src="${firstEvidence}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
          printEvidenceDiv.style.display = 'block';
      } else {
          printEvidenceDiv.innerHTML = '';
          printEvidenceDiv.style.display = 'none';
      }
  }

  function printCurrentForm() {
      const currentOrder = {
        woNumber: document.getElementById('wo-number').value,
        reqParty: document.getElementById('req-party').value,
        reqPosition: document.getElementById('req-position').value,
        building: document.getElementById('building').value,
        dateRequested: document.getElementById('date-requested').value,
        dateStarted: document.getElementById('date-started').value,
        estimateDateAccomplished: document.getElementById('estimate-date-accomplished').value,
        description: document.getElementById('description').value,
        status: document.getElementById('status').value,
        remarks: document.getElementById('remarks').value,
        technician: document.getElementById('performed-by').value,
        materials: getMaterialRows(),
        evidence: [],
        concurredBy: document.getElementById('concurred-by-select').value,
        concurredByTitle: document.getElementById('concurred-by-title').textContent,
        activities: getActivities(),
      };
      populatePrintTemplate(currentOrder, '-1');
      populatePrintTemplate(currentOrder, '-2');
      setTimeout(() => window.print(), 100);
  }

  function printSpecificWorkOrder(woNumber) {
      const order = allWorkOrders.find(o => o.woNumber === woNumber);
      if (!order) return alert('Work order not found.');
      populatePrintTemplate(order, '-1');
      populatePrintTemplate(order, '-2');
      setTimeout(() => window.print(), 100);
  }

  function printSummary() {
      const orders = [...allWorkOrders];
      if (orders.length === 0) return alert("No work orders to print.");
      orders.sort((a, b) => (parseInt(a.woNumber.replace(/\D/g, '')) || 0) - (parseInt(b.woNumber.replace(/\D/g, '')) || 0));
      const printWindow = window.open('', '', 'height=600,width=800');
      printWindow.document.write('<html><head><title>Work Order Summary</title><style>body{font-family:Arial,sans-serif;margin:20px}.header{overflow:hidden;margin-bottom:5px}.header img{width:70px}.header img.left{float:left}.header img.right{float:right}.header .university-info{text-align:center}h3{margin:0;font-size:12pt}p{margin:0;font-size:8pt}hr{border:none;height:2px;background-color:#000;margin:3px 0}h2{text-align:center;margin-top:20px}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #000;padding:8px;text-align:left;font-size:10pt}</style></head><body>');
      printWindow.document.write(`<div class="header"><img src="images/UCV.png" alt="logo" class="left"><img src="images/oppm logo.png" alt="logo" class="right"><div class="university-info"><h3>UNIVERSITY OF CAGAYAN VALLEY</h3><p>Victor Ventura Perez (VVP) Campus<br>Tuguegarao City<br>(078) 844-8978 | Fax: (078) 844-0086</p><p>OFFICE OF THE PHYSICAL PLANT AND MAINTENANCE</p><hr></div></div><h2>Work Order Summary Report</h2><table><thead><tr><th>WO#</th><th>Requesting Party</th><th>Building</th><th>Date Requested</th><th>Status</th></tr></thead><tbody>`);
      orders.forEach(order => {
        printWindow.document.write(`<tr><td>${order.woNumber}</td><td>${order.reqParty}</td><td>${order.building}</td><td>${order.dateRequested}</td><td>${order.status}</td></tr>`);
      });
      printWindow.document.write('</tbody></table></body></html>');
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
  }

    async function saveActivities() {
      if (!editingWoNumber) return alert("No work order selected.");

      const order = allWorkOrders.find(o => o.woNumber === editingWoNumber);
      if (!order) return alert("Work order not found.");

      order.activities = getActivities();

      try {
          const response = await fetch(`${API_URL}/${editingWoNumber}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(order)
          });
          if (!response.ok) throw new Error('Failed to save activities.');
          alert("Activities saved successfully!");
          closeActivitiesTablePopup();
          await fetchAllWorkOrders();
          displayWorkOrderDetails(editingWoNumber);
      } catch (error) {
          alert(`Error saving activities: ${error.message}`);
      }
  }

    async function saveCosting() {
        if (!editingWoNumber) return alert("No work order selected.");
        const order = allWorkOrders.find(o => o.woNumber === editingWoNumber);
        if (!order) return alert("Work order not found.");

        order.costing = Array.from(document.querySelectorAll('#costing-body tr')).map(row => {
            const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0;
            const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0;
            return {
                particular: row.querySelector('.cost-particular').value,
                quantity: row.querySelector('.cost-quantity').value,
                unit: row.querySelector('.cost-unit').value,
                unitCost: row.querySelector('.cost-unit-cost').value,
                total: (quantity * unitCost).toFixed(2)
            }
        });

        try {
            const response = await fetch(`${API_URL}/${editingWoNumber}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if (!response.ok) throw new Error('Failed to save costing.');
            alert("Costing data saved successfully!");
            closeCostingPopup();
            await fetchAllWorkOrders();
            displayWorkOrderDetails(editingWoNumber);
        } catch (error) {
            alert(`Error saving costing: ${error.message}`);
        }
    }

    async function saveStatusRemarks() {
        const order = allWorkOrders.find(o => o.woNumber === woNumberForStatusUpdate);
        if(!order) return alert("Work order not found.");

        order.status = document.getElementById('popup-status-select').value;
        order.remarks = document.getElementById('popup-remarks-textarea').value;

        try {
            const response = await fetch(`${API_URL}/${woNumberForStatusUpdate}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(order)
            });
            if(!response.ok) throw new Error('Failed to update status.');

            closeStatusRemarksPopup();
            await fetchAllWorkOrders(); // Refresh all data
            populateWorkOrderList(currentFilter);
            updateDashboardStats();
            if (editingWoNumber === woNumberForStatusUpdate) {
                displayWorkOrderDetails(woNumberForStatusUpdate);
            }
        } catch (error) {
            alert(`Error updating status: ${error.message}`);
        }
    }


    // The following functions are mostly unchanged as they handle local UI logic.
    function renderGanttChart(order) { if (ganttChart) { ganttChart.destroy(); } const ctx = document.getElementById('wo-gantt-canvas').getContext('2d'); const validActivities = (order.activities || []).filter(a => a.startDate && a.endDate); if (validActivities.length === 0) { ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.font = "16px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center"; ctx.fillText("No activities with timelines to display.", ctx.canvas.width / 2, ctx.canvas.height / 2); return; } const datasets = []; let minDate = new Date('2999-12-31'); let maxDate = new Date('1970-01-01'); validActivities.forEach((activity, index) => { const activityData = []; const startDate = new Date(activity.startDate); const endDate = new Date(activity.endDate); if (startDate.getTime() > maxDate.getTime()) maxDate = new Date(startDate); if (endDate.getTime() > maxDate.getTime()) maxDate = new Date(endDate); if (startDate.getTime() < minDate.getTime()) minDate = new Date(startDate); let currentDate = new Date(startDate); while (currentDate <= endDate) { activityData.push({ x: new Date(currentDate), y: activity.name || 'Untitled Activity', r: 10 }); currentDate.setDate(currentDate.getDate() + 1); } datasets.push({ label: activity.name || 'Untitled Activity', data: activityData, backgroundColor: colors[index % colors.length], pointStyle: 'rect', radius: 10, }); }); maxDate.setDate(maxDate.getDate() + 1); minDate.setDate(minDate.getDate() - 1); ganttChart = new Chart(ctx, { type: 'bubble', data: { datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (context) => context[0].dataset.label, label: (context) => `Date: ${new Date(context.raw.x).toLocaleDateString()}` } } }, scales: { y: { type: 'category', labels: validActivities.map(a => a.name || 'Untitled Activity'), offset: true, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } }, x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MMM d' } }, min: minDate, max: maxDate, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' }, ticks: { source: 'auto' } } } } }); }
    function openNewOrderPopup() { document.getElementById('new-order-popup').style.display = 'flex'; }
    function closeNewOrderPopup() { document.getElementById('new-order-popup').style.display = 'none'; }
    function showTablePopup() { document.getElementById('table-popup-overlay').style.display = 'flex'; }
    function closeTablePopup() { document.getElementById('table-popup-overlay').style.display = 'none'; }
    function showActivitiesTablePopup(activities) { if (editingWoNumber === null) { alert("Please select a work order first."); return; } document.getElementById('activities-wo-number-display').textContent = editingWoNumber; setActivities(activities); document.getElementById('activities-table-popup-overlay').style.display = 'flex'; }
    function closeActivitiesTablePopup() { document.getElementById('activities-table-popup-overlay').style.display = 'none'; }
    function addActivityRow() { const tbody = document.getElementById('activities-body'); const row = document.createElement('tr'); row.innerHTML = `<td><input type="text" class="activity-name"></td><td><input type="date" class="activity-start-date"></td><td><input type="date" class="activity-end-date"></td><td class="delete-column"><button onclick="deleteActivityRow(this)">🗑️</button></td>`; tbody.appendChild(row); }
    function deleteActivityRow(button) { const row = button.closest('tr'); row.remove(); }
    function getActivities() { return Array.from(document.querySelectorAll('#activities-body tr')).map(row => ({ name: row.querySelector('.activity-name')?.value || '', startDate: row.querySelector('.activity-start-date')?.value || '', endDate: row.querySelector('.activity-end-date')?.value || '' })); }
    function setActivities(activities) { const tbody = document.getElementById('activities-body'); tbody.innerHTML = ''; if (activities && activities.length > 0) { activities.forEach(activity => { const row = document.createElement('tr'); row.innerHTML = `<td><input type="text" class="activity-name" value="${activity.name || ''}"></td><td><input type="date" class="activity-start-date" value="${activity.startDate || ''}"></td><td><input type="date" class="activity-end-date" value="${activity.endDate || ''}"></td><td class="delete-column"><button onclick="deleteActivityRow(this)">🗑️</button></td>`; tbody.appendChild(row); }); } else { addActivityRow(); } }
    function showActivitiesPopup(activities) { const popupContent = document.getElementById('activities-list'); popupContent.innerHTML = ''; if (activities && activities.length > 0 && activities.some(a => a.name)) { activities.forEach((activity, index) => { if(!activity.name) return; const activityDiv = document.createElement('div'); activityDiv.classList.add('activity-item'); activityDiv.innerHTML = `<p><strong>Activity ${index + 1}:</strong> ${activity.name}</p><p><strong>Date Start:</strong> ${activity.startDate || 'N/A'}</p><p><strong>Date End:</strong> ${activity.endDate || 'N/A'}</p><hr>`; popupContent.appendChild(activityDiv); }); } else { popupContent.innerHTML = '<p>No activities recorded for this work order.</p>'; } document.getElementById('activities-popup-overlay').style.display = 'flex'; }
    function closeActivitiesPopup() { document.getElementById('activities-popup-overlay').style.display = 'none'; }
    function openAboutPopup() { document.getElementById('about-popup').style.display = 'flex'; }
    function closeAboutPopup() { document.getElementById('about-popup').style.display = 'none'; }
    function openCostingPopup(woNumber) { if (!editingWoNumber) { alert("Please select a work order first."); return; } document.getElementById('costing-wo-number-display').textContent = editingWoNumber; const order = allWorkOrders.find(o => o.woNumber === editingWoNumber); setCostingRows(order.costing); document.getElementById('costing-popup-overlay').style.display = 'flex'; }
    function closeCostingPopup() { document.getElementById('costing-popup-overlay').style.display = 'none'; }
    function addCostingRow(item = {}) { const tbody = document.getElementById('costing-body'); const row = document.createElement('tr'); const total = (parseFloat(item.quantity) || 0) * (parseFloat(item.unitCost) || 0); row.innerHTML = `<td><input type="text" class="cost-particular" value="${item.particular || ''}"></td><td><input type="number" class="cost-quantity" value="${item.quantity || ''}" oninput="calculateRowTotal(this.closest('tr'))"></td><td><input type="text" class="cost-unit" value="${item.unit || ''}"></td><td><input type="number" class="cost-unit-cost" value="${item.unitCost || ''}" oninput="calculateRowTotal(this.closest('tr'))"></td><td class="cost-total">${formatCurrency(total)}</td><td class="delete-column"><button onclick="deleteCostingRow(this)">🗑️</button></td>`; tbody.appendChild(row); }
    function deleteCostingRow(button) { button.closest('tr').remove(); updateGrandTotal(); }
    function calculateRowTotal(row) { const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0; const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0; const total = quantity * unitCost; row.querySelector('.cost-total').textContent = formatCurrency(total); updateGrandTotal(); }
    function updateGrandTotal() { let grandTotal = 0; document.querySelectorAll('#costing-body tr').forEach(row => { const quantity = parseFloat(row.querySelector('.cost-quantity').value) || 0; const unitCost = parseFloat(row.querySelector('.cost-unit-cost').value) || 0; grandTotal += quantity * unitCost; }); document.getElementById('grand-total').textContent = formatCurrency(grandTotal); }
    function setCostingRows(costingData) { const tbody = document.getElementById('costing-body'); tbody.innerHTML = ''; if (costingData && costingData.length > 0) { costingData.forEach(item => addCostingRow(item)); } else { addCostingRow(); } updateGrandTotal(); }
    function showMasterPrintPreview() { const woNumber = editingWoNumber; if (!woNumber) { alert("Please select a work order first."); return; } const order = allWorkOrders.find(o => o.woNumber === woNumber); if (!order) { alert('Work order not found.'); return; } let previewHtml = ''; const headerClone = document.querySelector('.dashboard-header').cloneNode(true); const pTags = headerClone.querySelectorAll('p'); pTags.forEach(p => { if(p.textContent.includes('DASHBOARD')) p.remove(); }); const leftLogo = headerClone.querySelector('img[style*="left"]'); const rightLogo = headerClone.querySelector('img[style*="right"]'); const headerText = `<div class="header-text">${headerClone.querySelector('h2').outerHTML}${headerClone.querySelector('p').outerHTML}</div>`; previewHtml += `<div class="header" style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 30px;">${leftLogo ? leftLogo.outerHTML : '<div></div>'}${headerText}${rightLogo ? rightLogo.outerHTML : '<div></div>'}</div>`; const detailsSectionClone = document.getElementById('selected-wo-details-section').cloneNode(true); detailsSectionClone.querySelector('.details-actions').remove(); if (detailsSectionClone.querySelector('#evidence-section')) { detailsSectionClone.querySelector('#evidence-section').remove(); } const ganttCanvas = document.getElementById('wo-gantt-canvas'); const ganttImage = ganttCanvas.toDataURL('image/png'); detailsSectionClone.querySelector('.wo-gantt-section').innerHTML = '<h4>Gantt Chart Timeline</h4><div class="gantt-container" style="width: 100%; margin-top: 15px;"><img src="' + ganttImage + '" style="max-width: 100%; border: 1px solid #eee;"></div>'; previewHtml += '<div class="print-section" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">' + detailsSectionClone.innerHTML; const signatoriesHtml = `<div class="signatories" style="display: flex; justify-content: space-around; margin-top: 70px; text-align: center; width: 100%; page-break-inside: avoid;"><div class="signature-box" style="width: 45%;"><strong>Performed by:</strong><br><br>${order.technician || 'N/A'}</p></div><div class="signature-box" style="width: 45%;"><strong>Requesting Party:</strong><br><br>${order.reqParty}</p></div></div><div class="signatories" style="margin-top: 50px; display: flex; justify-content: space-around; text-align: center; width: 100%; page-break-inside: avoid;"><div class="signature-box" style="margin: auto; width: 45%;"><strong>Concurred by:</strong><br><br>${order.concurredBy}</p></div></div>`; previewHtml += signatoriesHtml + '</div>'; if (order.costing && order.costing.length > 0) { previewHtml += '<div class="print-section" style="margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">'; previewHtml += '<h2>Project Costing</h2>'; previewHtml += '<table style="width: 100%; border-collapse: collapse; font-size: 10pt;"><thead><tr><th style="border: 1px solid #000; padding: 5px;">Particulars</th><th style="border: 1px solid #000; padding: 5px;">Quantity</th><th style="border: 1px solid #000; padding: 5px;">Unit</th><th style="border: 1px solid #000; padding: 5px;">Unit Cost</th><th style="border: 1px solid #000; padding: 5px;">Total</th></tr></thead><tbody>'; let grandTotal = 0; order.costing.forEach(item => { const itemTotal = parseFloat(item.total) || 0; grandTotal += itemTotal; previewHtml += `<tr><td style="border: 1px solid #000; padding: 5px;">${item.particular}</td><td style="border: 1px solid #000; padding: 5px;">${item.quantity}</td><td style="border: 1px solid #000; padding: 5px;">${item.unit}</td><td style="border: 1px solid #000; padding: 5px;">${formatCurrency(parseFloat(item.unitCost) || 0)}</td><td style="border: 1px solid #000; padding: 5px;">${formatCurrency(itemTotal)}</td></tr>`; }); previewHtml += '</tbody></table>'; previewHtml += `<div style="text-align: right; margin-top: 10px; font-weight: bold; font-size: 12pt;">Grand Total: ${formatCurrency(grandTotal)}</div>`; previewHtml += '</div>'; } if (order.evidence && order.evidence.length > 0) { previewHtml += '<div class="print-section" style="page-break-before: always; margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid;">'; previewHtml += '<h2>Picture Evidences</h2>'; previewHtml += '<div class="evidence-container" style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px;">'; order.evidence.forEach(imgData => { previewHtml += `<img src="${imgData}" style="width: 6cm; height: 8cm; object-fit: cover; border: 1px solid #ccc; padding: 4px; border-radius: 4px;">`; }); previewHtml += '</div></div>'; } document.getElementById('master-print-preview-content').innerHTML = previewHtml; document.getElementById('master-print-preview-popup').style.display = 'flex'; }
    function closeMasterPrintPreview() { document.getElementById('master-print-preview-popup').style.display = 'none'; }
    function executeMasterPrint() { const printContent = document.getElementById('master-print-preview-content').innerHTML; const printWindow = window.open('', '', 'height=800,width=800'); printWindow.document.write('<html><head><title>Work Order Details & Evidence</title>'); const styles = `body { font-family: Arial, sans-serif; margin: 0; padding: 0; } .print-section { margin-bottom: 25px; padding-bottom: 25px; border-bottom: 2px dashed #ccc; page-break-inside: avoid; } .print-section:last-of-type { border-bottom: none; } .header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 30px; } .header img { width: 90px; height: auto; } .header-text { text-align: center; } .header-text h2, .header-text p { margin: 2px 0; } h2 { text-align: center; margin-bottom: 20px; } .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px 20px; margin: 0 auto 20px auto; max-width: 98%; } .details-grid p { margin: 4px 0; font-size: 11pt; border-bottom: 1px dotted #eee; padding-bottom: 4px; } .details-grid strong { display: inline-block; width: 160px; } .signatories { display: flex; justify-content: space-around; margin-top: 70px; text-align: center; width: 100%; page-break-inside: avoid; } .signature-box { width: 45%; } .signature-line { border-top: 1px solid black; margin: 40px 10px 5px 10px; padding-top: 8px; } .evidence-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 20px; } .evidence-container img { width: 6cm; height: 8cm; object-fit: cover; border: 1px solid #ccc; padding: 4px; border-radius: 4px; } .gantt-container { width: 100%; margin-top: 15px; } .gantt-container img { max-width: 100%; border: 1px solid #eee; } table { width: 100%; border-collapse: collapse; font-size: 10pt; } th, td { border: 1px solid #000; padding: 5px; }`; printWindow.document.write('<style>' + styles + '</style>'); printWindow.document.write('<style> @page { size: 8.5in 13in; margin: 10mm; } </style>'); printWindow.document.write('</head><body>'); printWindow.document.write(printContent); printWindow.document.write('</body></html>'); printWindow.document.close(); printWindow.focus(); setTimeout(() => { printWindow.print(); printWindow.close(); }, 500); }
    function openStatusRemarksPopup(woNumber, event) { event.stopPropagation(); woNumberForStatusUpdate = woNumber; const order = allWorkOrders.find(o => o.woNumber === woNumber); if (order) { document.getElementById('status-remarks-wo-number-display').textContent = woNumber; document.getElementById('popup-status-select').value = order.status; document.getElementById('popup-remarks-textarea').value = order.remarks || ''; document.getElementById('status-remarks-popup-overlay').style.display = 'flex'; } }
    function closeStatusRemarksPopup() { document.getElementById('status-remarks-popup-overlay').style.display = 'none'; }
    function viewAllGanttCharts() { const orders = allWorkOrders; if (orders.length === 0) { alert("No work orders available to display Gantt charts."); return; } document.getElementById('selected-wo-details-section').style.display = 'none'; const allGanttSection = document.getElementById('all-gantt-charts-section'); allGanttSection.style.display = 'block'; const container = document.getElementById('all-gantt-container'); container.innerHTML = ''; allGanttCharts.forEach(chart => chart.destroy()); allGanttCharts = []; orders.forEach((order, index) => { const card = document.createElement('div'); card.className = 'single-gantt-card'; card.innerHTML = `<h4>WO#: ${order.woNumber} (${order.reqParty})</h4><canvas id="gantt-canvas-${index}"></canvas>`; container.appendChild(card); const ctx = document.getElementById(`gantt-canvas-${index}`).getContext('2d'); const validActivities = (order.activities || []).filter(a => a.startDate && a.endDate); if (validActivities.length === 0) { ctx.font = "14px Arial"; ctx.fillStyle = "#888"; ctx.textAlign = "center"; ctx.fillText("No activities to display.", ctx.canvas.width / 2, 75); return; } const datasets = []; let minDate = new Date('2999-12-31'); let maxDate = new Date('1970-01-01'); validActivities.forEach((activity, activityIndex) => { const activityData = []; const startDate = new Date(activity.startDate); const endDate = new Date(activity.endDate); if (startDate.getTime() > maxDate.getTime()) maxDate = new Date(startDate); if (endDate.getTime() > maxDate.getTime()) maxDate = new Date(endDate); if (startDate.getTime() < minDate.getTime()) minDate = new Date(startDate); let currentDate = new Date(startDate); while (currentDate <= endDate) { activityData.push({ x: new Date(currentDate), y: activity.name || 'Untitled Activity', r: 10 }); currentDate.setDate(currentDate.getDate() + 1); } datasets.push({ label: activity.name || 'Untitled Activity', data: activityData, backgroundColor: colors[activityIndex % colors.length], pointStyle: 'rect', radius: 10, }); }); maxDate.setDate(maxDate.getDate() + 1); minDate.setDate(minDate.getDate() - 1); const chart = new Chart(ctx, { type: 'bubble', data: { datasets: datasets }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { title: (context) => context[0].dataset.label, label: (context) => `Date: ${new Date(context.raw.x).toLocaleDateString()}` } } }, scales: { y: { type: 'category', labels: validActivities.map(a => a.name || 'Untitled Activity'), offset: true, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } }, x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'MMM d' } }, min: minDate, max: maxDate, grid: { display: true, color: 'rgba(0, 0, 0, 0.15)' } } } } }); allGanttCharts.push(chart); }); }
</script>
</body>

</html>
>>>>>>> a7f2185463788768a50b39c6676093e0f56afe60
